<!DOCTYPE html>
<html lang="en">
<head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

 <!-- Favicon -->
  <link rel="shortcut icon" href="ai.ico">
  <link rel="icon" href="ai.ico">

  <meta charset="UTF-8">
  <title>Customer/Competitor Analyzer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Fonts and basic styles from CDN -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <style>

/* Place into <style> block */
#powerOptionsMenu {
  font-family: inherit;
  margin-top:6px;
  border:1px solid #e0e0e0;
}
.power-option {
  padding: 0.9rem 1.3rem;
  border-bottom: 1px solid #f3f3f3;
  cursor: pointer;
  font-size: 1.07rem;
  color: #222;                /* Make options visible by default */
  background: #fff;           /* Ensure light background */
  transition: background 0.14s, color 0.14s;
}

.power-option:last-child { border-bottom:none;}
.power-option:hover { background:#ffeaea; color:#b71c1c;}



    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f7f8fa;
      margin: 0;
      color: #1a1a1a;
    }
    header {
      background: #2c3e50;
      color: #fff;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px #0001;
    }
    .title {
      font-size: 1.6rem;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .top-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    select, button {
      font-size: 1rem;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      border: 1px solid #c0c0c0;
      margin-left: 0.3rem;
      margin-right: 0.3rem;
    }
    button#helpBtn, button#newAnalysisBtn {
      background: #3578e5;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    button#helpBtn:hover, button#newAnalysisBtn:hover {
      background: #214a99;
    }
    #chat {
      margin: 1.2rem auto;
      max-width: 680px;
      background: #fff;
      padding: 1.2rem 2rem 2.5rem 2rem;
      border-radius: 14px;
      min-height: 540px;
      box-shadow: 0 4px 16px #0002;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1.3rem;
    }
    .chat-bubble {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      margin-bottom: 0.4rem;
      position: relative;
    }
    .chat-bubble.user {
      flex-direction: row-reverse;
    }
    .chat-img {
      width: 40px; min-width: 40px; height: 40px;
      background: #eee;
      border-radius: 50%;
      display: flex;
      align-items: center; justify-content: center;
      font-size: 1.4rem;
      overflow: hidden;
    }
    .chat-img img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .chat-content {
      background: #e9f0fb;
      padding: 1rem 1.4rem 1rem 1.1rem;
      border-radius: 10px;
      min-width: 60px;
      max-width: 480px;
      white-space: pre-wrap;
      font-size: 1.07rem;
      position: relative;
      word-break: break-word;
    }
    .chat-bubble.user .chat-content {
      background: #dde7ee;
    }
    .copy-btn {
      position: absolute;
      top: 7px; right: 7px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.15rem;
      color: #1877f2;
      opacity: 0.8;
      transition: opacity 0.15s;
    }
    .copy-btn:hover { opacity: 1; }
    .chat-timestamp {
      font-size: 0.82rem;
      color: #69788c;
      margin-top: 2px;
      margin-left: 49px;
    }
    #inputBoxArea {
      display: flex;
      gap: 0.5rem;
      margin-top: auto;
      background: #fff;
      border-radius: 8px;
      padding-top: 0.5rem;
    }
    #inputPrompt {
      flex: 1;
      resize: none;
      font-size: 1.08rem;
      border-radius: 7px;
      border: 1px solid #cdd5e0;
      padding: 0.7rem;
    }
    #sendBtn {
      border: none;
      background: #2e6ae6;
      color: #fff;
      font-weight: 600;
      border-radius: 6px;
      font-size: 1.08rem;
      padding: 0.7rem 1.4rem;
      margin-left: 0.2rem;
      cursor: pointer;
      transition: background 0.15s;
    }
    #sendBtn:disabled { color: #aaa; background: #e2e7ef; cursor: not-allowed;}
    .bottom-btns {
      display: flex;
      gap: 2.2rem;
      margin-top: 1.3rem;
      justify-content: center;
      align-items: center;
    }
    .big-action-btns {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
    }
    .main-action-btn {
      font-weight: 600;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 1.2rem 2.4rem;
      font-size: 1.18rem;
      margin-bottom: 0.4rem;
      background: #1877f2;
      box-shadow: 0 2px 8px #1877f229;
      cursor: pointer;
      transition: background 0.2s;
    }
    .main-action-btn:hover {
      background: #094aaf;
    }
    .smallbtn-label {
      color: #414d56;
      font-size: 0.98rem;
      margin-top: 3px;
      text-align: center;
      font-weight: 500;
    }
    .prompt-edit-label {
      margin: 1rem 0 0.2rem 0;
      font-size: 1.01rem;color: #546070;
      font-weight: 600;
    }
    textarea#systemPromptEdit {
      width: 100%; min-height: 70px; border-radius: 7px;
      border: 1px solid #adc6e0;
      font-size: 1.0rem; padding: 0.7rem;
      margin-bottom: 0.6rem;
      margin-top: 0.1rem;
    }
    /* Toast */
    .toast {
      display: none;
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 1rem 2rem;
      background: #d32f2f;   /* Power Options button color */
      color: #fff;
      border-radius: 11px;
      font-weight: 600;
      font-size: 1.03rem;
      z-index: 9999;
      opacity: 0.96;
      box-shadow: 0 2px 10px #2225;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    .toast.show { display: block; }
    /* Popup modal */
    #modalPopup {
      display: none;
      position: fixed;
      z-index: 10020;
      left:0; top:0; width:100vw; height:100vh;
      background: #0006;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 2rem 2.2rem;
      max-width: 480px;
      width: 90%;
      min-width: 240px;
      position: relative;
      box-shadow: 0 2px 22px #0004;
    }
    .modal-close {
      position: absolute;
      right: 18px;
      top: 10px;
      font-size: 1.7rem;
      color: #3a4557;
      background: none;
      border: none;
      cursor: pointer;
      line-height: 1;
    }
    @media (max-width:540px) {
      header { flex-direction: column; align-items: flex-start;gap:1rem;}
      #chat { max-width: 98vw; padding:0.8rem 0.6rem 2rem 0.8rem;}
      .main-action-btn { width:93vw; padding:1rem 0;}
      .chat-content { max-width:88vw;}
    }
  </style>
</head>
<body>
  <header>
    <span class="title">Customer/Competitor Analyzer</span>
    <div class="top-actions">

 <div id="powerOptionsWrapper" style="position:relative;">
      <button id="powerOptionsBtn" style="background:#d32f2f;color:#fff;font-weight:700;border:none;padding:0.6rem 1.1rem;border-radius:6px;cursor:pointer;box-shadow:0 2px 6px #b71c1c1a;font-size:1rem;">Power Options â–¼</button>
      <div id="powerOptionsMenu" style="position:absolute;left:0;top:100%;display:none;background:#fff;min-width:240px;box-shadow:0 8px 32px #25252545;border-radius:8px;z-index:99;">
        <div class="power-option" data-tool="strategic"   >Strategic Advice</div>
        <div class="power-option" data-tool="swot"        >SWOT Analysis</div>
        <div class="power-option" data-tool="proposal"    >Generate Proposal/Email</div>
        <div class="power-option" data-tool="objection"   >Customer Objection Handler</div>
        <div class="power-option" data-tool="export"      >Save/Export Full Analyses</div>
     
      </div>
    </div>


      <button id="helpBtn">Help</button>

<!-- Add this label span just before the dropdown -->
  <span id="priorsLabel" style="font-weight: 600; color: #fff; margin-right: 0px; user-select:none;">
    Priors âž£
  </span>
      <select id="priorsDropdown" style="margin-left:0px;"></select>
      <button id="newAnalysisBtn">New Analysis</button>
    </div>
  </header>
  <main>
    <div style="max-width:750px; margin: 0 auto;">
      <div id="chat">
<img src="logo3.png" style="width:150px;height:40px;"  alt="SocialAI">
      
        <textarea id="systemPromptEdit"></textarea>
      </div>
      <div class="bottom-btns">
        <div class="big-action-btns">
          <button class="main-action-btn" id="customerAnalysisBtn">Customer Analysis</button>
          <span class="smallbtn-label"></span>
        </div>
        <div class="big-action-btns">
          <button class="main-action-btn" id="competitorAnalysisBtn">Competitor Analysis</button>
          <span class="smallbtn-label"></span>
        </div>
      </div>
  
 <form id="inputBoxArea">
  <textarea id="inputPrompt" rows="2">Search for current or open RFPs for:&nbsp</textarea>
  <button type="submit" id="sendBtn">Send</button>
</form>


    </div>
  </main>
  <div class="toast" id="toast"></div>
  <!-- Modal Popup (Help/Analysis prompt) -->
  <div id="modalPopup">
    <div class="modal-content" id="modalContent">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div id="modalInnerContent"></div>
    </div>
  </div>
  <script>


    // === CONFIGURABLE SYSTEM PROMPT ===
    const DEFAULT_SYSTEM_PROMPT =  `ðŸ’¬Â Prompt to the Analyzer (you can modify this):\n
You are an expert business analyst specializing in laboratory sciences and industrial services.\n
Purpose: To analyze the company "ALS Global" and compare its capabilities with current or potential customers (for customer fit and solution suggestions) and with competitors (to identify competitive advantages).\n
Instructions for responding:\n
- Analyze provided information about ALS Global, the customer/prospect, or competitor.\n
- Show sources for any external facts where possible, or explain reasoning if none.\n
- Structure all answers in clearly formatted bulleted lists, numbered lists, and outlines. Avoid paragraphs â€“ use concise, scan-friendly points.\n
- Present action items at end of response if applicable.\n\n
(You may edit this prompt as needed.)`;

    const CUSTOMER_ANALYSIS_PROMPT = `Analyze the following customer for potential matches with ALS Global's laboratory and testing services. Summarize the customer's business, likely service needs, and recommend sales approaches or service angles for ALS Global. Be sure to list specific business units and to include contact names and phone numbers and email addresses for appropriate people to contact at each business unit. Indicate if specific contact individuals are notavailable. Show sources where possible. Reply in bulleted/outlined form. Company info:\n\n`;
    const COMPETITOR_ANALYSIS_PROMPT = `Analyze the following competitor to ALS Global. Summarize the competitor's business, service offerings, and highlight areas of overlap or difference with ALS Global. Suggest sales talking points for ALS Global. Be sure to list specific business units and to include contact names and phone numbers and email addresses for appropriate people to contact at each business unit. Indicate if specific contact individuals are notavailable. Show sources where possible. Reply in bulleted/outlined form. Company info:\n\n`;

// ======= STRATEGIC ADVICE PROMPT TEMPLATE (editable) =======
const STRATEGIC_ADVICE_PROMPT = `
You are a strategic business consultant for ALS Global (or the customer/competitor).
- Provide actionable, high-level strategic advice using all available information: Company name, location, analysis type (Customer Compare or Competitor Compare), and any stated business goal or challenge.
- Organize your response in clear, bulleted or numbered lists/outlines.
- If a specific business goal or challenge is given, address it directly; otherwise, assess overall strategy based on context.
- End with concise, prioritized action items for business leaders.
[Information and request follows:]
`;


// ======= SWOT ANALYSIS PROMPT TEMPLATE (editable) =======
const SWOT_ANALYSIS_PROMPT = `
You are a business analyst performing a detailed SWOT (Strengths, Weaknesses, Opportunities, Threats) analysis.

- Use all available information such as company/entity name, location, analysis type (customer or competitor), and any additional context.
- Provide a clear, structured SWOT report with sections for each category.
- Use concise, bulleted lists with actionable insights.
- Tailor the analysis to help ALS Global's management or sales teams strategize effectively.

[Details and request below:]
`;


// ======= PROPOSAL/EMAIL DRAFT PROMPT TEMPLATE (editable) =======
const PROPOSAL_EMAIL_PROMPT = `
You are a professional sales communications expert specializing in laboratory sciences and industrial services.

- Based on the provided company details, location, analysis type (customer or competitor), and any additional business context:
- Generate or refine a clear, persuasive, and professional sales proposal or email draft tailored to the customer's needs.
- Organize the content with an engaging introduction, key value propositions, relevant services, and a clear call to action.
- Respond in a well-structured format suitable for sending directly to the customer or client.
- Avoid overly technical jargon unless relevant, and highlight ALS Globalâ€™s unique advantages.

[Details and request below:]
`;

// ======= CUSTOMER OBJECTION HANDLER PROMPT TEMPLATE =======
const CUSTOMER_OBJECTION_PROMPT = `
You are a skilled sales professional specialized in laboratory sciences and industrial services.

- Provide a structured, convincing reply addressing the objection/concern.
- Include effective sales talking points and handling strategies.
- Use all information available: company/entity name, location, analysis type (customer or competitor), any additional context or project details.
- Organize your response in concise bulleted or enumerated form suitable for use directly in sales communication.

[Objection and details below:]
`;

const OBJECTION_RESPONSES = {
  "Price Too High": `Acknowledge customer's concern about price and emphasize value:
- Highlight ALS Global's superior accuracy and compliance certifications.
- Emphasize reliability and timeliness reducing risk and cost overruns.
- Offer to explore flexible pricing or bundled services options.
- Reinforce long-term ROI and quality assurance benefits.`,

  "Prefer Existing Vendor": `Respect their loyalty, then differentiate ALS Global:
- Point out ALS Global's cutting-edge technology and global reach.
- Share success stories that show better outcomes or faster delivery.
- Offer pilot trials or proof of concept to demonstrate superior service.
- Emphasize commitment to partnership and responsiveness.`,

  "Not Convinced of Value": `Clarify and quantify ALS Global's value proposition:
- Explain unique service offerings unavailable elsewhere.
- Present case studies or data showing cost savings or compliance gains.
- Address specific business pain points mentioned by the customer.
- Highlight expert team capabilities and tailored solutions.`,

  "Unsure About Technical Capability": `Build confidence through expertise and credentials:
- Provide detailed information on ALS Global's technical expertise.
- Share certifications, accreditations, and client testimonials.
- Offer to connect customer with subject matter experts.
- Explain quality management and continuous improvement processes.`,

  "Other": `Please specify the objection or concern in detail so we can provide tailored handling strategies.`
};



    // === TOGETHER.AI CONFIG ===
    const TOGETHER_API_KEY = "tgp_v1_xmNEMdb6ZIZ41g9mzpHiFSm2mw1sUNYXOc-PrjNhaNQ";
    const TOGETHER_API_URL = "https://api.together.xyz/v1/chat/completions";
    const TOGETHER_MODEL = "meta-llama/Llama-3-8b-chat-hf"; // change model as desired

    // ========== MAIN UI/CHAT LOGIC ==========
    let conversationId = "";
    let conversations = {}; // { [id]: { messages: [...], updated: ts } }
    let systemPrompt = DEFAULT_SYSTEM_PROMPT;
    let isSending = false;

    // ========== INIT ==========
    function loadConversations() {
      try {
        const local = window.localStorage.getItem("alsg_conversations");
        conversations = local ? JSON.parse(local) : {};
      } catch { conversations = {}; }
    }
    function saveConversations() {
      window.localStorage.setItem("alsg_conversations", JSON.stringify(conversations));
    }
    function setConversation(id) {
      if (!conversations[id]) conversations[id] = { messages: [], updated: Date.now() };
      conversationId = id;
      renderPriors();
      renderChat();
    }

    function renderPriors() {
      const dropdown = document.getElementById('priorsDropdown');
      dropdown.innerHTML = "";
      const idsSorted = Object.keys(conversations).sort((a, b) => (conversations[b]?.updated || 0) - (conversations[a]?.updated || 0));
      idsSorted.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id; opt.text = id;
        dropdown.appendChild(opt);
      });
      dropdown.value = conversationId;
    }

    // ========== CHAT UI RENDER ==========
    function renderChat() {
      const chat = document.getElementById('chat');
      // Remove old bubbles except system prompt
      [...chat.querySelectorAll('.chat-bubble,.chat-timestamp')].forEach(el => el.remove());
      let msgs = (conversations[conversationId]?.messages || []);
      msgs.forEach((m, i) => {
        const bubble = document.createElement('div');
        bubble.className = "chat-bubble" + (m.role==="user"?" user":"");
        // Avatar
        const img = document.createElement('div');
        img.className = "chat-img";
      
img.innerHTML = `<img src="${m.role === "user"
  ? "person1.jpg"
  : "ai.png"}" alt="${m.role==="user"?"You":"AI"}">`;

        bubble.appendChild(img);
        // Message content
        const cont = document.createElement('div');
        cont.className = "chat-content";
        cont.innerHTML = m.content
            .replace(/^- /gm, 'â€¢ ')
            .replace(/\n/g, "<br>");
        // Copy button only for assistant
        if (m.role === "assistant") {
          const cbtn = document.createElement('button');
          cbtn.className = "copy-btn";
          cbtn.innerText = "â§‰";
          cbtn.title = "Copy";
          cbtn.onclick = () => {
            copyToClipboard(m.content);
            showToast("Copied!");
          };
          cont.appendChild(cbtn);
        }
        bubble.appendChild(cont);
        chat.appendChild(bubble);

        // Timestamp
        const d = new Date(m.ts || (Date.now() - (msgs.length-i)*60000));
        const ts = document.createElement('div');
        ts.className = "chat-timestamp";
        ts.textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) +
          (m.role === "user" ? " (You)" : " (AI)");
        chat.appendChild(ts);
      });
      chat.scrollTop = chat.scrollHeight+300;
      // Restore system prompt textarea
      document.getElementById("systemPromptEdit").value = systemPrompt;
    }
    // ========== EVENT HANDLERS ==========
    function setSystemPrompt(text) {
      systemPrompt = text;
      window.localStorage.setItem("alsg_system_prompt", systemPrompt);
    }
    window.onload = function() {
      // System prompt
      const localPrompt = window.localStorage.getItem("alsg_system_prompt");
      if (localPrompt) systemPrompt = localPrompt;
      document.getElementById("systemPromptEdit").value = systemPrompt;
      document.getElementById("systemPromptEdit").addEventListener("blur", e => {
        setSystemPrompt(e.target.value);
      });
      // Conversation
      loadConversations();
      let ids = Object.keys(conversations);
      setConversation(ids[0] || "Analysis-1");

      // Analysis create
      document.getElementById("newAnalysisBtn").onclick = function() {
        showModal(`<label>Enter Analysis ID:<br><input id="newCid" style="padding:0.4rem; font-size:1rem; border-radius:5px; margin-top:0.3rem;" maxlength="50"></label>
        <button id="goNewCidBtn" style="display:inline;margin-left:0.7rem;padding:0.4rem 1.1rem;font-size:1rem;border-radius:4px;background:#3578e5;color:#fff;font-weight:600;border:none;">Create &amp; Switch</button>`);
        setTimeout(()=>{
          document.getElementById("newCid").focus();
          document.getElementById("goNewCidBtn").onclick = function() {
            let id = document.getElementById("newCid").value.trim() || "Analysis-" + (Object.keys(conversations).length+1);
            setConversation(id);
            closeModal();
          };
        },200);
      };
      // Prior selection
      document.getElementById("priorsDropdown").onchange = function(e) {
        setConversation(e.target.value);
      };
      // Help
      document.getElementById("helpBtn").onclick = function() {
        showModal(`<h2>Help: Customer/Competitor Analyzer</h2>
<ul style="font-size:1rem;line-height:1.55;"><li>Create a new Analysis session using "New Analysis" and provide any identifier you want.</li>
<li>Select past sessions via the "Priors" dropdown â€“ chat history is stored per analysis.</li>
<li>Edit (or reset) the system prompt above to adjust AIâ€™s instructions/format.</li>
<li>Use the "Customer Analysis" or "Competitor Analysis" buttons for focused prompts; youâ€™ll be guided for input.</li>
<li>Type or paste your own questions/instructions below.</li>
<li>Click "â§‰" to copy any AI answer; you'll get confirmation.</li>
<li>All chats are stored in your browser only and stay on your device.</li><li>Select Power Options for advanced functions.</li></ul>
`);
      };
      // Main input box
      document.getElementById("inputBoxArea").onsubmit = async function(e) {
        e.preventDefault();
        let prompt = document.getElementById("inputPrompt").value.trim();
        if (!prompt || isSending) return;
        await submitUserPrompt(prompt);
        document.getElementById("inputPrompt").value = "";
      };
      // Customer/Competitor Analysis buttons
      document.getElementById("customerAnalysisBtn").onclick = function() {
        analysisPromptPopup('customer');
      };
      document.getElementById("competitorAnalysisBtn").onclick = function() {
        analysisPromptPopup('competitor');
      };
      // Restore chat
      renderChat();
  
// In your JS in window.onload (before renderChat();), add:

// Power Options dropdown logic
const powerOptionsWrapper = document.getElementById('powerOptionsWrapper');
const powerOptionsBtn = document.getElementById('powerOptionsBtn');
const powerOptionsMenu = document.getElementById('powerOptionsMenu');

// Dropdown toggle
powerOptionsBtn.onclick = function(e) {
  e.stopPropagation();
  const visible = powerOptionsMenu.style.display === 'block';
  document.querySelectorAll('#powerOptionsMenu').forEach(m=>m.style.display='none');
  powerOptionsMenu.style.display = visible ? 'none' : 'block';
};
// Hide on click elsewhere
document.body.addEventListener('click', () =>
  (powerOptionsMenu.style.display = 'none'));

// Item click handlers for each option
Array.from(powerOptionsMenu.querySelectorAll('.power-option')).forEach(opt => {
  opt.onclick = function(e) {
    const tool = this.getAttribute('data-tool');
    powerOptionsMenu.style.display = 'none';

    openPowerToolPopup(tool);

// Wire up the Analyze & Advise button after modal loads

if (tool === 'strategic') {
  setTimeout(() => {
    document.getElementById('analyzeStrategicBtn').onclick = async function() {
      closeModal();
      await handleStrategicAdviceAction();
    };
  }, 120);
}

if (tool === 'swot') {
  setTimeout(() => {
    document.getElementById('generateSwotBtn').onclick = async function() {
      closeModal();
      await handleSwotAnalysisAction();
    };
  }, 120);
}



if (tool === 'proposal') {
  setTimeout(() => {
    document.getElementById('generateProposalBtn').onclick = async function() {
      closeModal();
      await handleProposalDraftAction();
    };
  }, 120);
}

if (tool === 'export') {
  setTimeout(() => {
    document.getElementById('saveAsPdfBtn').onclick = async function() {
      closeModal();
      showToast("Exporting PDF...", true);
      await exportCurrentAnalysisAsPDF();
      hideToast();
    };

    document.getElementById('exportCsvBtn').onclick = async function() {
      closeModal();
      showToast("Exporting CSV...", true);
      await exportCurrentAnalysisAsCSV();
      hideToast();
    };
  }, 120);
}


if (tool === 'objection') {
  setTimeout(() => {
    // Open secondary popup immediately on dropdown selection (except empty)
    const objectionSelect = document.getElementById('objectionSelect');
    objectionSelect.onchange = function () {
      const val = this.value;
      if (val) {
        openObjectionDetailPopup(val);
      }
    };

if (tool === 'examples') {
  setTimeout(() => {
    // Handle clicks on prompt buttons: send prompt and close popup
    Array.from(document.querySelectorAll('.example-btn')).forEach(btn => {
      btn.onclick = async function() {
        const promptText = this.getAttribute('data-prompt');
        if (promptText) {
          closeModal();
          showToast("Analyzing...", true);
          await submitUserPrompt(promptText);
        }
      };
    });

    // Handle the "Search the ALS Global Website" button
    document.getElementById('searchWebsiteBtn').onclick = function() {
      closeModal();
      // Open the ALS Global website in a styled popup window
      const width = 900;
      const height = 700;
      const left = (window.screen.width / 2) - (width / 2);
      const top = (window.screen.height / 2) - (height / 2);
      const features = `width=${width},height=${height},left=${left},top=${top},` +
                       `resizable=yes,scrollbars=yes,menubar=no,toolbar=no,location=no,status=no`;
      window.open('https://alsglobal.com', 'ALSGlobalSite', features);
    };
  }, 120);
}


    // Handle "Handle Objection" button (submit to chatbot)
    document.getElementById('handleObjectionBtn').onclick = async function() {
      const selectedObjection = objectionSelect.value;
      if (!selectedObjection) {
        showToast("Please select an objection.");
        return;
      }
      closeModal();
      await handleObjectionAction();
    };
  }, 120);
}



  }
});

// Core stub/mockup popups for each tool
function openPowerToolPopup(tool) {
  let html = '';
  switch(tool) {
    
case 'strategic':
  html = `<h2>Strategic Advice</h2>
    <div style="margin-bottom:1rem;">
      <label>Business Goal or Challenge:</label><br>
      <input id="strategicGoalInput" style="width:95%;" placeholder="e.g. Entering a new sector, boosting margins, etc.">
    </div>
    <div style="margin:1rem 0 0.5rem 0">
      <button id="analyzeStrategicBtn" style="padding:0.6rem 1.3rem;border-radius:6px;background:#2979ff;color:#fff;font-weight:600;border:none;">Analyze &amp; Advise</button>
    </div>
    <div class="tool-desc" style="margin-top:1.1rem;color:#666;font-size:1.04rem;">
      The AI chatbot will suggest high-level directions tailored to your current analysis or business challenge.
    </div>`;
  break;


  case 'swot':
  html = `<h2>SWOT Analysis</h2>
    <div style="margin-bottom:0.6rem;">
      <label>Entity (ALS Global / Customer / Competitor):</label><br>
      <input id="swotEntityInput" style="width:95%;" placeholder="Company or division...">
    </div>
    <div style="margin:1rem 0 0.5rem 0">
      <button id="generateSwotBtn" style="padding:0.6rem 1.3rem; border-radius:6px; background:#2979ff; color:#fff; font-weight:600; border:none;">Generate SWOT</button>
    </div>
    <div class="tool-desc" style="margin-top:1.1rem; color:#666; font-size:1.04rem;">
      Get a structured breakdown of Strengths, Weaknesses, Opportunities, and Threats suitable for board or sales use.
    </div>`;
  break;


   case 'proposal':
  html = `<h2>Proposal/Email Draft</h2>
    <div style="margin-bottom:0.6rem;">
      <label>Target Customer/Contact:</label><br>
      <input id="proposalCustomerInput" style="width:95%;" placeholder="Customer Name, Contact">
    </div>
    <div style="margin-bottom:0.6rem;">
      <label>Context/Project Needs:</label><br>
      <textarea id="proposalContextInput" style="width:98%; height:70px;" placeholder="Outline opportunity, project, or customer pain points"></textarea>
    </div>
    <div>
      <button id="generateProposalBtn" style="padding:0.6rem 1.3rem; border-radius:6px; background:#2979ff; color:#fff; font-weight:600; border:none;">Draft Email/Proposal</button>
    </div>
    <div class="tool-desc" style="margin-top:1rem; color:#666; font-size:1.04rem;">
      The AI chatbot will generate or refine a professional sales communication for this context. Use it as email or to build a presentation/proposal.</div>`;
  break;



case 'objection':
  html = `<h2>Customer Objection Handler</h2>
    <div>
      <label>Objection / Concern: <br>
      <select id="objectionSelect" style="width:97%; margin-bottom:0.6rem;">
        <option value="">Select Common Objection...</option>
        <option value="Price Too High">Price Too High</option>
        <option value="Prefer Existing Vendor">Prefer Existing Vendor</option>
        <option value="Not Convinced of Value">Not Convinced of Value</option>
        <option value="Unsure About Technical Capability">Unsure About Technical Capability</option>
        <option value="Other">Other</option>
      </select>
      </label>
      <label>Additional Context:</label><br>
      <input id="objectionContextInput" style="width:95%;" placeholder="(optional) e.g., details about project/customer">
    </div>
    <div style="margin-top:0.9rem;">
      <button id="handleObjectionBtn" style="background:#2979ff; color:#fff; font-weight:600; padding:0.6rem 1.3rem; border:none; border-radius:6px;">
        Handle Objection
      </button>
    </div>
    <div style="margin-top:1rem; color:#666; font-size:1rem;">
      This assistant will generate a structured reply with convincing sales talking points and handling strategies. You can inject this as a prompt into your chat or copy it for use elsewhere.
    </div>`;
  break;

   
 case 'export':
  html = `
    <h2>Save/Export Full Analyses</h2>
    <div style="margin-bottom:1rem;">Download or export your current analysis session:</div>
    <button id="saveAsPdfBtn" style="
      background:#388e3c;
      color:#fff;
      font-weight:600;
      margin:0 0.7rem 0.7rem 0;
      padding:0.55rem 1.4rem;
      border:none;
      border-radius:6px;
      cursor: pointer;">
      Save as PDF
    </button>
    <button id="exportCsvBtn" style="
      background:#00838f;
      color:#fff;
      font-weight:600;
      margin:0 0.7rem 0.7rem 0;
      padding:0.55rem 1.4rem;
      border:none;
      border-radius:6px;
      cursor: pointer;">
      Export CSV
    </button>
    <div style="margin-top:1.2rem;color:#666;">Export analyses as PDF or CSV for reporting and sharing. You can also copy your chats manually in realtime. To export a different analysis, select it from the Priorsâž£  dropdown list.
  `;
  break;


case 'examples':
  html = `<h2>Example Prompt Library</h2>
    <div style="margin-bottom:1rem;">One-click to insert popular prompt ideas:</div>
    <ul style="padding-left:1.5em; list-style-type: disc;">
      <li><button class="example-btn" data-prompt="Identify growth opportunities for ALS Global in 2025" style="margin-bottom:4px; cursor:pointer;">Growth Opportunities for ALS Global in 2025</button></li>
      <li><button class="example-btn" data-prompt="Compare service offerings of ALS Global and Bureau Veritas" style="margin-bottom:4px; cursor:pointer;">Compare Service Offerings with Bureau Veritas</button></li>
      <li><button class="example-btn" data-prompt="How can ALS Global improve project delivery?" style="margin-bottom:4px; cursor:pointer;">How can ALS Global improve project delivery?</button></li>
      <li><button id="searchWebsiteBtn" style="margin-top:0.4rem; cursor:pointer;">Search the ALS Global Website</button></li>
    </ul>
    <div style="margin-top:1.2rem;color:#666;">Use these prompt examples as a starting point; you can inject them into chat with one click or edit before sending.</div>`;
  break;


  }
  showModal(html);
}


  };

    // ========== MODAL ==========
    function showModal(html) {
      document.getElementById("modalInnerContent").innerHTML = html;
      document.getElementById("modalPopup").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("modalPopup").style.display = "none";
    }
    // ========== HANDLERS ==========
    async function submitUserPrompt(prompt) {
      appendMessage('user', prompt);
      renderChat();
      await sendToAI(prompt);
    }
    function appendMessage(role, content) {
      let obj = { role, content, ts: Date.now() };
      conversations[conversationId].messages.push(obj);
      conversations[conversationId].updated = Date.now();
      saveConversations();
    }
    // === AI REQUEST ===
    async function sendToAI(userPrompt) {
      isSending = true;
      try {

 // Show persistent toast
    showToast("Analyzing...", true);

        let history = conversations[conversationId].messages;
        // Only keep {role,content} for API (truncate history if huge for safety)
        let simpleHistory = history.slice(-16).map(m => ({
          role: m.role==='user'?'user':'assistant', content:m.content
        }));
        // Prepend system prompt
        let messages = [
          {role:"system",content:systemPrompt},
          ...simpleHistory,
          {role: "user", content: userPrompt}
        ];
        // Compose API request
      
const placeholderContent = `
  <div style="display:flex; align-items:center; gap: 8px;">
    <img src="spinner.gif" alt="Thinking" style="width:24px; height:24px;"/>
    <span>Analyzing . . .</span>
  </div>
`;

// Add placeholder bubble
appendMessage('assistant', placeholderContent.trim());
renderChat();

       
 let resp = await fetch(TOGETHER_API_URL, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + TOGETHER_API_KEY,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: TOGETHER_MODEL,
            messages: messages,
            max_tokens: 1000,
            temperature: 0.4
          })
        });
        let data = await resp.json();
        let ai_answer = ((data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content : "AI error or no response.");
        // Replace placeholder

  let idx = conversations[conversationId].messages.findIndex(m =>
  m.role === "assistant" && m.content.trim() === placeholderContent.trim()
);
if (idx > -1) {
  conversations[conversationId].messages[idx] = { role:"assistant", content: ai_answer, ts: Date.now() };
} else {
  // Fallback if not found, append new message
  appendMessage('assistant', ai_answer);
}
saveConversations();
renderChat();
      } finally {
        isSending = false;
      }
    }

    // ========== ANALYSIS PROMPT POPUP ==========
    function analysisPromptPopup(type) {
      showModal(`<h3>${type === "customer" ? "Customer" : "Competitor"} Analysis</h3>
        <label>Company name:<br>
          <input id="analysisName" type="text" maxlength="80" style="width:93%;padding:0.4rem;font-size:1rem; border-radius:6px;" autofocus required>
        </label>
        <br>
        <label>Location (optional):<br>
          <input id="analysisLoc" type="text" maxlength="80" style="width:93%;padding:0.4rem;margin-bottom:0.3rem;font-size:1rem;border-radius:6px;">
        </label>
        <br>
        <label>Other info (business details, context):<br>
          <textarea id="analysisOther" rows="2" style="width:93%;padding:0.4rem;font-size:1rem; border-radius:6px;"></textarea>
        </label>
        <br>
        <div style="margin:0.6rem 0 0.2rem 0;font-weight:500">Prompt to AI:<br>
          <textarea id="promptTemplate" style="width:98%; min-height:48px; border-radius:7px;font-size:1rem;padding:0.3rem;margin-top:0.2rem;">${type === "customer"? CUSTOMER_ANALYSIS_PROMPT : COMPETITOR_ANALYSIS_PROMPT}</textarea>
        </div>
        <button style="margin-top:0.6rem;font-size:1.06rem;padding:0.5rem 1.5rem;border-radius:5px;background:#2e6ae6;color:#fff;font-weight:600;border:none;" id="doAnalysisBtn">Submit</button>
      `);
      setTimeout(()=>{
        document.getElementById("doAnalysisBtn").onclick = async function() {
          let cname = document.getElementById("analysisName").value.trim();
          let loc = document.getElementById("analysisLoc").value.trim();
          let more = document.getElementById("analysisOther").value.trim();
          let template = document.getElementById("promptTemplate").value;
          if (!cname) { showToast("Enter a company name"); return;}
          let fullPrompt = template + `Name: ${cname}\n` +
            (loc?(`Location: ${loc}\n`):"") +
            (more?(`Other info: ${more}\n`):"");
          closeModal();
          await submitUserPrompt(fullPrompt);
        };
      },150);
    }

    // === UTIL ===
    function showToast(msg) {
      let toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "toast show";
      setTimeout(()=>{ toast.className="toast"; }, 1400);
    }
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text);
      } else {
        // fallback
        let txt = document.createElement('textarea');
        txt.value = text;
        document.body.appendChild(txt);
        txt.select(); document.execCommand('copy');
        document.body.removeChild(txt);
      }
    }

async function handleStrategicAdviceAction() {
  // ========== Context Extraction ==========
  let conversation = conversations[conversationId];
  let analyzerType = null, entityName = null, entityLocation = null, otherInfo = null;
  if (conversation && conversation.messages) {
    for (let m of conversation.messages) {
      if (!entityName && m.content.match(/Name:\s*(.*)/i))        entityName     = m.content.match(/Name:\s*(.*)/i)[1];
      if (!entityLocation && m.content.match(/Location:\s*(.*)/i)) entityLocation = m.content.match(/Location:\s*(.*)/i)[1];
      if (!otherInfo && m.content.match(/Other info:\s*([\s\S]*)/i)) otherInfo = m.content.match(/Other info:\s*([\s\S]*)/i)[1];
      // Detect type
      if (!analyzerType && m.content.toLowerCase().includes("customer analysis")) analyzerType = "Customer Compare";
      if (!analyzerType && m.content.toLowerCase().includes("competitor analysis")) analyzerType = "Competitor Compare";
    }
  }
  // Grab popup input (if any)
  let popupVal = '';
  try {
    popupVal = document.getElementById('strategicGoalInput') ? document.getElementById('strategicGoalInput').value.trim() : '';
  } catch {}

  // ========== Build Composite Prompt ==========
  let infoBlock = "";
  if (entityName)       infoBlock += `Company/Entity Name: ${entityName}\n`;
  if (entityLocation)   infoBlock += `Location: ${entityLocation}\n`;
  if (analyzerType)     infoBlock += `Analysis Type: ${analyzerType}\n`;
  if (otherInfo)        infoBlock += `Other Info: ${otherInfo}\n`;
  if (popupVal)         infoBlock += `Specific Business Goal/Challenge: ${popupVal}\n`;

  let fullPrompt = STRATEGIC_ADVICE_PROMPT + infoBlock;

  await submitUserPrompt(fullPrompt);
}

async function handleProposalDraftAction() {
  // Extract context from current conversation
  let conversation = conversations[conversationId];
  let analysisType = null, entityName = null, entityLocation = null, otherInfo = null;

  if (conversation && conversation.messages) {
    for (let m of conversation.messages) {
      if (!entityName && m.content.match(/Name:\s*(.*)/i))
        entityName = m.content.match(/Name:\s*(.*)/i)[1];
      if (!entityLocation && m.content.match(/Location:\s*(.*)/i))
        entityLocation = m.content.match(/Location:\s*(.*)/i)[1];
      if (!otherInfo && m.content.match(/Other info:\s*([\s\S]*)/i))
        otherInfo = m.content.match(/Other info:\s*([\s\S]*)/i)[1];
      if (!analysisType && m.content.toLowerCase().includes("customer analysis"))
        analysisType = "Customer Compare";
      if (!analysisType && m.content.toLowerCase().includes("competitor analysis"))
        analysisType = "Competitor Compare";
    }
  }

  // Get user inputs from popup
  let custInput = '';
  try {
    custInput = document.getElementById('proposalCustomerInput')?.value.trim() || '';
  } catch {}

  let contextInput = '';
  try {
    contextInput = document.getElementById('proposalContextInput')?.value.trim() || '';
  } catch {}

  // Build prompt detail block
  let details = "";
  if (entityName) details += `Company Name: ${entityName}\n`;
  if (entityLocation) details += `Location: ${entityLocation}\n`;
  if (analysisType) details += `Analysis Type: ${analysisType}\n`;
  if (otherInfo) details += `Other Info: ${otherInfo}\n`;
  if (custInput) details += `Target Customer/Contact: ${custInput}\n`;
  if (contextInput) details += `Context/Project Needs: ${contextInput}\n`;

  // Compose full prompt
  let fullPrompt = PROPOSAL_EMAIL_PROMPT + details;

  // Submit prompt to chatbot
  await submitUserPrompt(fullPrompt);
}

async function handleSwotAnalysisAction() {
  // Extract context from current conversation
  let conversation = conversations[conversationId];
  let analysisType = null, entityName = null, entityLocation = null, otherInfo = null;

  if (conversation && conversation.messages) {
    for (let m of conversation.messages) {
      if (!entityName && m.content.match(/Name:\s*(.*)/i))
        entityName = m.content.match(/Name:\s*(.*)/i)[1];
      if (!entityLocation && m.content.match(/Location:\s*(.*)/i))
        entityLocation = m.content.match(/Location:\s*(.*)/i)[1];
      if (!otherInfo && m.content.match(/Other info:\s*([\s\S]*)/i))
        otherInfo = m.content.match(/Other info:\s*([\s\S]*)/i)[1];
      if (!analysisType && m.content.toLowerCase().includes("customer analysis"))
        analysisType = "Customer Compare";
      if (!analysisType && m.content.toLowerCase().includes("competitor analysis"))
        analysisType = "Competitor Compare";
    }
  }

  // Get user input from popup
  let entityInput = '';
  try {
    entityInput = document.getElementById('swotEntityInput')?.value.trim() || '';
  } catch {}

  // Build prompt details block
  let details = "";
  if (entityName) details += `Company/Entity Name: ${entityName}\n`;
  if (entityLocation) details += `Location: ${entityLocation}\n`;
  if (analysisType) details += `Analysis Type: ${analysisType}\n`;
  if (otherInfo) details += `Other Info: ${otherInfo}\n`;
  if (entityInput) details += `Entity for SWOT Analysis: ${entityInput}\n`;

  // Compose full prompt
  let fullPrompt = SWOT_ANALYSIS_PROMPT + details;

  // Send prompt to chatbot
  await submitUserPrompt(fullPrompt);
}

function openObjectionDetailPopup(objection) {
  const responseText = OBJECTION_RESPONSES[objection] || "No prepared response available.";
  let html = `
    <h3>Objection: ${objection}</h3>
    <div style="white-space: pre-wrap; background:#f9f9f9; border:1px solid #ddd; padding:1rem; border-radius:6px; max-height:220px; overflow-y:auto; margin-bottom:1rem; font-size:1rem; color:#333;">
      ${responseText}
    </div>
    <button id="copyObjectionResponseBtn" style="background:#1976d2; color:#fff; border:none; padding:0.5rem 1.2rem; border-radius:5px; font-weight:600; cursor:pointer; margin-right:1rem;">
      Copy Response
    </button>
    <button id="useObjectionInChatBtn" style="background:#2e7d32; color:#fff; border:none; padding:0.5rem 1.2rem; border-radius:5px; font-weight:600; cursor:pointer;">
      Use in Chat & Close
    </button>
  `;

  showModal(html);

  setTimeout(() => {
    document.getElementById('copyObjectionResponseBtn').onclick = () => {
      copyToClipboard(responseText);
      showToast("Copied!");
    };

    document.getElementById('useObjectionInChatBtn').onclick = async () => {
      // Compose prompt and submit to chat, then close both popups
      closeModal(); // closes secondary popup
      // Also close main popup if open
      const mainModal = document.getElementById("modalPopup");
      if (mainModal) mainModal.style.display = "none";

      await submitObjectionPrompt(objection, responseText);
    };
  }, 100);
}

async function submitObjectionPrompt(objection, additionalText = "") {
  let conversation = conversations[conversationId];
  let analysisType = null, entityName = null, entityLocation = null, otherInfo = null;

  if (conversation && conversation.messages) {
    for (let m of conversation.messages) {
      if (!entityName && m.content.match(/Name:\s*(.*)/i))
        entityName = m.content.match(/Name:\s*(.*)/i)[1];
      if (!entityLocation && m.content.match(/Location:\s*(.*)/i))
        entityLocation = m.content.match(/Location:\s*(.*)/i)[1];
      if (!otherInfo && m.content.match(/Other info:\s*([\s\S]*)/i))
        otherInfo = m.content.match(/Other info:\s*([\s\S]*)/i)[1];
      if (!analysisType && m.content.toLowerCase().includes("customer analysis"))
        analysisType = "Customer Compare";
      if (!analysisType && m.content.toLowerCase().includes("competitor analysis"))
        analysisType = "Competitor Compare";
    }
  }

  // Build prompt detail block
  let details = "";
  if (entityName) details += `Company/Entity Name: ${entityName}\n`;
  if (entityLocation) details += `Location: ${entityLocation}\n`;
  if (analysisType) details += `Analysis Type: ${analysisType}\n`;
  if (otherInfo) details += `Other Info: ${otherInfo}\n`;
  details += `Objection: ${objection}\n`;
  if (additionalText) details += `Additional Handling Context:\n${additionalText}\n`;

  // Compose full prompt
  let fullPrompt = CUSTOMER_OBJECTION_PROMPT + details;

  // Send prompt to chatbot
  await submitUserPrompt(fullPrompt);
}

async function handleObjectionAction() {
  const objection = document.getElementById('objectionSelect')?.value || '';
  if (!objection) {
    showToast("Please select an objection.");
    return;
  }
  const additionalContext = document.getElementById('objectionContextInput')?.value.trim() || '';
  await submitObjectionPrompt(objection, additionalContext);
  closeModal();
}


function hideToast() {
  const toast = document.getElementById("toast");
  toast.className = "toast";
}

// Export conversation as CSV
async function exportCurrentAnalysisAsCSV() {
  const messages = conversations[conversationId]?.messages || [];
  if (messages.length === 0) {
    showToast("No conversation data to export.");
    return;
  }

  // Prepare CSV headers and rows
  const rows = [
    ['Timestamp', 'Role', 'Content']
  ];
  messages.forEach(m => {
    const dateStr = m.ts ? new Date(m.ts).toLocaleString() : '';
    // Escape quotes in content by doubling them, and remove line breaks for CSV
    const cleanContent = m.content.replace(/"/g, '""').replace(/[\r\n]+/g, ' ');
    rows.push([dateStr, m.role, cleanContent]);
  });

  // Convert to CSV string
  const csvContent = rows.map(r => r.map(val => `"${val}"`).join(",")).join("\n");
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

  // Trigger file download
  triggerDownload(blob, `analysis_${conversationId}.csv`);
}

// Export conversation as PDF using jsPDF
async function exportCurrentAnalysisAsPDF() {
  const { jsPDF } = window.jspdf;

  const messages = conversations[conversationId]?.messages || [];
  if (messages.length === 0) {
    showToast("No conversation data to export.");
    return;
  }

  const doc = new jsPDF({unit: 'pt', format: 'a4'});
  const margin = 40;
  const maxLineWidth = doc.internal.pageSize.getWidth() - 2 * margin;
  let y = margin;

  // Title
  doc.setFontSize(18);
  doc.text(`Analysis Report: ${conversationId}`, margin, y);
  y += 30;
  doc.setFontSize(12);

  // Helper: wrap text lines for PDF
  function addWrappedText(text, x, y) {
    const lines = doc.splitTextToSize(text, maxLineWidth);
    doc.text(lines, x, y);
    return y + lines.length * 15;
  }

  for (let m of messages) {
    if(y > doc.internal.pageSize.height - margin) {
      doc.addPage();
      y = margin;
    }

    const timeStr = m.ts ? new Date(m.ts).toLocaleString() : '';
    // Add timestamp and role label
    doc.setFont(undefined, 'bold');
    doc.text(`${timeStr} (${m.role})`, margin, y);
    y += 16;

    // Add content (plain text)
    doc.setFont(undefined, 'normal');
    y = addWrappedText(m.content.replace(/\n/g, ' '), margin, y + 2);
    y += 10;
  }

  // Save PDF file; triggers download dialog
  doc.save(`analysis_${conversationId}.pdf`);
}

// Helper: trigger download dialog from Blob
function triggerDownload(blob, filename) {
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

  </script>
</body>
</html>
