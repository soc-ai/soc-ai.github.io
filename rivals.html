<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Virtual Team of Rival Advisors</title>

<!-- Favicon -->
  <link rel="shortcut icon" href="ai.ico">
  <link rel="icon" href="ai.ico">

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f9fafc; }
    .bubble { position:relative; }
    .advisor-label {
      position: absolute; top: 8px; left: 14px;
      font-size: 1.07em; font-weight: 700; color: #2563eb;
    }
    .copy-btn {
      position: absolute; top: 10px; right: 14px; background: none;
      border: none; font-size: 1.2em; color: #374151; cursor: pointer; opacity: 0.68;
    }
    .copy-btn:hover {opacity:1;}
    .toast {
      display: none; position: fixed; top: 35px; left: 50%;
      transform: translateX(-50%);
      background: #2563eb; color: #fff;
      padding: 12px 32px; border-radius: 7px; font-size: 1.12em;
      z-index: 2000; min-width: 170px; text-align: center;
      box-shadow: 0 2px 16px rgba(0,0,0,0.12); pointer-events:none;
    }
    @media (max-width: 1024px) {
      .advisor-grid { flex-direction: column !important; }
      .bubble { width: 95% !important; margin: 0.5rem auto !important; }
    }

    /* Modal styles */
    #helpModal.hidden { display: none; }
    #helpModal {
      display: flex;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #helpModalContent {
      background: white;
      border-radius: 0.5rem;
      max-height: 80vh;
      max-width: 500px;
      overflow-y: auto;
      padding: 1.5rem 2rem;
      position: relative;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    #helpModalContent p {
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }
    #helpModalClose {
      background: none;
      border: none;
      font-size: 1.8rem;
      position: absolute;
      right: 0.7rem;
      top: 0.3rem;
      cursor: pointer;
      color: #666;
      font-weight: bold;
    }
    #helpModalClose:hover {
      color: #222;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

<header class="bg-[#0f172a] text-white p-6 shadow text-2xl font-bold flex items-center gap-3 justify-between">
  <div class="flex items-center gap-3">
    <img src="ai.gif" class="h-8 w-8 rounded" alt="AI" />
    <span>Virtual Team of Rival Advisors  —   Get Perspectives from Experts</span>
  </div>
  <button id="helpBtn" aria-label="Help"
    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold text-base">
    Help
  </button>
</header>

<main class="flex flex-col flex-1 w-full max-w-5xl mx-auto mt-7 px-2 pb-10">

  <!-- Prompts for Each Expert -->
  <section class="bg-white shadow rounded-lg p-5 mb-6">
    <div class="mb-3 text-[#0f172a] font-semibold text-xl">Define Expert Personas (you may edit and enhance)</div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label for="philosopherPrompt" class="block text-sm font-bold text-blue-900 mb-1">Philosopher</label>
        <textarea id="philosopherPrompt" class="w-full border border-blue-200 rounded p-2" rows="5">You are Philosopher, an AI advisor who is calm, detached, and non-confrontational. Always approach questions with a balanced perspective, discussing both sides of every issue, and never take an extreme stance.</textarea>
      </div>
      <div>
        <label for="mbaPrompt" class="block text-sm font-bold text-blue-900 mb-1">MBA</label>
        <textarea id="mbaPrompt" class="w-full border border-blue-200 rounded p-2" rows="5">You are MBA, an AI advisor who is assertive, excitable, and pushy. Always approach questions aggressively, focusing on maximizing success and growth, giving bold, enthusiastic recommendations for action.</textarea>
      </div>
      <div>
        <label for="cassandraPrompt" class="block text-sm font-bold text-blue-900 mb-1">Cassandra</label>
        <textarea id="cassandraPrompt" class="w-full border border-blue-200 rounded p-2" rows="5">You are Cassandra, an AI advisor who is negative, detached, and always cautious. Approach every question with skepticism, highlighting risks, pitfalls and downsides. Never offer false hope and always emphasize what could go wrong.</textarea>
      </div>
    </div>
  </section>

  <!-- Chat display -->
  <section id="chatHistory" class="flex flex-col gap-8"></section>

  <!-- Entry and buttons -->
  <form id="chatForm" class="mt-4 flex flex-col sm:flex-row items-center bg-white rounded shadow px-4 py-3 gap-2" autocomplete="off">
    <div class="flex-1 flex flex-row items-center w-full">
      <input id="chatInput" type="text" required autocomplete="off" placeholder="What is your strategic dilemma or question?" class="w-full px-3 py-2 rounded border border-gray-300 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-600 text-lg" />
      <button id="submitBtn" type="submit"
        class="bg-blue-700 hover:bg-blue-900 text-white px-4 py-2 rounded font-semibold transition flex items-center gap-1 text-lg"
        aria-label="Send question"
        title="Send your question to three expert advisors with different perspectives on the issue">
        ➣
        <img id="submitSpinner" src="spinner.gif" alt="Loading" class="hidden w-8 h-8"/>
      </button>
      <button id="roundRobinBtn" type="button"
        class="bg-green-700 hover:bg-green-900 text-white px-4 py-2 rounded font-semibold transition flex items-center gap-1 text-lg ml-2"
        aria-label="Round Robin"
        title="Have each expert respond to the others' advice in a second round of analysis"
        disabled>
        Round Robin
        <img id="roundRobinSpinner" src="spinner.gif" alt="Loading" class="hidden w-8 h-8"/>
      </button>
    </div>
  </form>

  <div id="toast" class="toast"></div>
</main>

<!-- Help modal -->
<div id="helpModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
  <div id="helpModalContent" class="modal-content">
    <button id="helpModalClose" aria-label="Close help popup">&times;</button>
    <h2 id="helpModalTitle" class="text-2xl font-bold mb-4">About Virtual Team of Rival Advisors</h2>
    <p>This app uses three AI experts with distinct personalities (Philosopher, MBA, Cassandra) to answer your strategic questions. Enter a question and see the varied advice each expert provides.</p>
    <p>You can edit each expert's persona prompt before asking a question to tailor their style and approach.</p>
<p>After receiving initial answers, you can press the Round Robin button to generate a further round of answers where the experts respond to EACH OTHERS' analysis.</p>
    <p>Answers can be copied to clipboard using the ⧉ button in each expert's response bubble. The copied text will include the expert's name.</p>
    <p>The app queries our powerful AI models sequentially to generate best results.</p>
    <p>If you experience any issues, please wait a moment between questions or retry individual responses.</p>
  </div>
</div>

<script>
  const TOGETHER_KEY = "tgp_v1_xmNEMdb6ZIZ41g9mzpHiFSm2mw1sUNYXOc-PrjNhaNQ";
  const TOGETHER_MODEL = "deepseek-ai/DeepSeek-V3.1";

  function getPrompts() {
    return {
      Philosopher: document.getElementById("philosopherPrompt").value.trim(),
      MBA: document.getElementById("mbaPrompt").value.trim(),
      Cassandra: document.getElementById("cassandraPrompt").value.trim()
    }
  }

  let chatExchanges = [];
  let lastRound1Answers = null;

  function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(showToast._timeout);
    showToast._timeout = setTimeout(() => { toast.style.display = "none"; }, 1200);
  }

  function setupCopyBtns() {
    document.querySelectorAll(".copy-btn").forEach(btn => {
      btn.onclick = async function () {
        const bubble = btn.closest(".bubble");
        const expertNameElem = bubble.querySelector(".advisor-label");
        const expertName = expertNameElem ? expertNameElem.textContent.trim().replace(" Round Robin", "") : "Expert";
        const round = bubble.closest(".round-robin") ? "Round Robin" : "First Round";
        const val = btn.getAttribute("data-copy") || "";
        const textToCopy = `Response Expert ${expertName} ${round}:\n\n${val}`;
        try {
          await navigator.clipboard.writeText(textToCopy);
          showToast("Copied!");
        } catch (err) {
          alert("Failed to copy: " + err);
        }
      };
    });
  }

  function renderHistory() {
    const container = document.getElementById("chatHistory");
    container.innerHTML = "";
    chatExchanges.forEach(ex => {
      const userDiv = document.createElement("div");
      userDiv.className = "my-2 flex justify-center";
      userDiv.innerHTML = `<div class="text-md font-semibold text-gray-800 bg-blue-50 border border-blue-100 rounded px-5 py-3 max-w-[700px]">${ex.user}</div>`;
      container.appendChild(userDiv);

      const firstRoundDiv = document.createElement("div");
      firstRoundDiv.className = "advisor-grid flex flex-row gap-4 justify-center mb-6 first-round";
      ["Philosopher", "MBA", "Cassandra"].forEach(advisor => {
        const bg = advisor === "Philosopher" ? "bg-gray-50" : (advisor === "MBA" ? "bg-green-50" : "bg-pink-50");
        const txt = advisor === "Philosopher" ? "text-gray-800" : (advisor === "MBA" ? "text-green-900" : "text-pink-900");
        const val = ex[advisor] || "<span class='italic text-gray-400'>[no response]</span>";
        const bubble = document.createElement("div");
        bubble.className = `bubble relative shadow-sm ${bg} ${txt} rounded-lg p-5 text-base w-[350px] min-h-[115px] border border-gray-200`;
        bubble.innerHTML = `
          <span class="advisor-label">${advisor}</span>
          <button class="copy-btn" data-copy="${val.replace(/"/g, '&quot;')}" title="Copy answer">⧉</button>
          <div style="margin-top:2.7em; white-space:pre-line;">${val}</div>
        `;
        firstRoundDiv.appendChild(bubble);
      });
      container.appendChild(firstRoundDiv);

      if (ex.roundRobin) {
        const rrDiv = document.createElement("div");
        rrDiv.className = "advisor-grid flex flex-row gap-4 justify-center round-robin";
        ["Philosopher", "MBA", "Cassandra"].forEach(advisor => {
          const bg = advisor === "Philosopher" ? "bg-gray-100" : (advisor === "MBA" ? "bg-green-100" : "bg-pink-100");
          const txt = advisor === "Philosopher" ? "text-gray-900" : (advisor === "MBA" ? "text-green-900" : "text-pink-900");
          const val = ex.roundRobin[advisor] || "<span class='italic text-gray-400'>[no round robin response]</span>";
          const bubble = document.createElement("div");
          bubble.className = `bubble relative shadow-lg ${bg} ${txt} rounded-lg p-5 text-base w-[350px] min-h-[115px] border border-gray-300`;
          bubble.innerHTML = `
            <span class="advisor-label">${advisor} Round Robin</span>
            <button class="copy-btn" data-copy="${val.replace(/"/g, "&quot;")}" title="Copy answer">⧉</button>
            <div style="margin-top:2.7em; white-space:pre-line;">${val}</div>
          `;
          rrDiv.appendChild(bubble);
        });
        container.appendChild(rrDiv);
      }
    });
    setupCopyBtns();
  }

  async function askTogether(expertPrompt, question) {
    const chat = [
      { role: "system", content: expertPrompt },
      { role: "user", content: question }
    ];
    try {
      const res = await fetch("https://api.together.ai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + TOGETHER_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: TOGETHER_MODEL,
          messages: chat,
          temperature: 0.7,
          max_tokens: 512
        })
      });
      let data;
      try { data = await res.json(); } catch (e) { return "[Invalid LLM response]"; }
      if (!res.ok) {
        if (data && data.error && data.error.message) return "[Error] " + data.error.message;
        return `[LLM Error ${res.status}]`;
      }
      return data.choices?.[0]?.message?.content?.trim() || "[no answer]";
    } catch (err) {
      return "[Network error: " + err.message + "]";
    }
  }

  function delay(ms) {
    return new Promise(res => setTimeout(res, ms));
  }

  async function queryAllAdvisors(question) {
    const prompts = getPrompts();
    const advisors = ["Philosopher", "MBA", "Cassandra"];
    const answers = {};
    for (let adv of advisors) {
      answers[adv] = await askTogether(prompts[adv], question);
      renderPartialHistory(question, answers);
      await delay(1800);
    }
    return answers;
  }

  async function queryRoundRobin(question, round1Answers) {
    const prompts = getPrompts();
    const advisors = ["Philosopher", "MBA", "Cassandra"];
    const rrAnswers = {};
    for (let adv of advisors) {
      const others = advisors.filter(a => a !== adv);
      let promptText = prompts[adv] + "\n\n";
      promptText += `Original question: ${question}\n\n`;
      promptText += `Other experts' answers from first round:\n`;
      for (let other of others) {
        promptText += `${other} said:\n${round1Answers[other]}\n\n`;
      }
      promptText += `Please analyze and give your thoughtful follow-up opinion.`;
      rrAnswers[adv] = await askTogether(promptText, question);
      renderRoundRobinPartialHistory(question, lastRound1Answers, rrAnswers);
      await delay(1800);
    }
    return rrAnswers;
  }

  function renderPartialHistory(question, answers) {
    const container = document.getElementById("chatHistory");
    let lastRow = container.lastChild;
    if (lastRow && lastRow.classList.contains("advisor-grid")) {
      container.removeChild(lastRow);
      container.removeChild(container.lastChild);
    }
    const userDiv = document.createElement("div");
    userDiv.className = "my-2 flex justify-center";
    userDiv.innerHTML = `<div class="text-md font-semibold text-gray-800 bg-blue-50 border border-blue-100 rounded px-5 py-3 max-w-[700px]">${question}</div>`;
    container.appendChild(userDiv);

    const row = document.createElement("div");
    row.className = "advisor-grid flex flex-row gap-4 justify-center";
    ["Philosopher", "MBA", "Cassandra"].forEach(advisor => {
      const bg = advisor === "Philosopher" ? "bg-gray-50" : (advisor === "MBA" ? "bg-green-50" : "bg-pink-50");
      const txt = advisor === "Philosopher" ? "text-gray-800" : (advisor === "MBA" ? "text-green-900" : "text-pink-900");
      const val = answers[advisor] || "<span class='italic text-gray-400'>[waiting]</span>";
      const bubble = document.createElement("div");
      bubble.className = `bubble relative shadow-sm ${bg} ${txt} rounded-lg p-5 text-base w-[350px] min-h-[115px] border border-gray-200`;
      bubble.innerHTML = `
        <span class="advisor-label">${advisor}</span>
        <button class="copy-btn" data-copy="${val.replace(/"/g, '&quot;')}" title="Copy answer">⧉</button>
        <div style="margin-top:2.7em; white-space:pre-line;">${val}</div>
      `;
      row.appendChild(bubble);
    });
    container.appendChild(row);
    setupCopyBtns();
  }

  function renderRoundRobinPartialHistory(question, round1Answers, rrAnswers) {
    const container = document.getElementById("chatHistory");
    let existingRR = container.querySelector(".round-robin");
    if (existingRR) {
      container.removeChild(existingRR);
    }
    const rrDiv = document.createElement("div");
    rrDiv.className = "advisor-grid flex flex-row gap-4 justify-center round-robin mt-6 mb-12";
    ["Philosopher", "MBA", "Cassandra"].forEach(advisor => {
      const bg = advisor === "Philosopher" ? "bg-gray-100" : (advisor === "MBA" ? "bg-green-100" : "bg-pink-100");
      const txt = advisor === "Philosopher" ? "text-gray-900" : (advisor === "MBA" ? "text-green-900" : "text-pink-900");
      const val = rrAnswers[advisor] || "<span class='italic text-gray-400'>[waiting for round robin response]</span>";
      const bubble = document.createElement("div");
      bubble.className = `bubble relative shadow-lg ${bg} ${txt} rounded-lg p-5 text-base w-[350px] min-h-[115px] border border-gray-300`;
      bubble.innerHTML = `
        <span class="advisor-label">${advisor} Round Robin</span>
        <button class="copy-btn" data-copy="${val.replace(/"/g, "&quot;")}" title="Copy answer">⧉</button>
        <div style="margin-top:2.7em; white-space:pre-line;">${val}</div>
      `;
      rrDiv.appendChild(bubble);
    });
    container.appendChild(rrDiv);
    setupCopyBtns();
  }

  document.getElementById("chatForm").onsubmit = async function (e) {
    e.preventDefault();
    showSubmitSpinner(true);
    document.getElementById("chatInput").disabled = true;
    document.getElementById("roundRobinBtn").disabled = false;
    lastRound1Answers = await queryAllAdvisors(document.getElementById("chatInput").value.trim());
    chatExchanges.push({
      user: document.getElementById("chatInput").value.trim(),
      Philosopher: lastRound1Answers.Philosopher,
      MBA: lastRound1Answers.MBA,
      Cassandra: lastRound1Answers.Cassandra
    });
    renderHistory();
    showSubmitSpinner(false);
    document.getElementById("chatInput").value = "";
    document.getElementById("chatInput").disabled = false;
  };

  document.getElementById("roundRobinBtn").addEventListener("click", async () => {
    if (!lastRound1Answers) {
      alert("Please submit a question first to generate initial expert answers.");
      return;
    }
    showRoundRobinSpinner(true);
    const question = chatExchanges[chatExchanges.length - 1]?.user || "";
    const roundRobinAnswers = await queryRoundRobin(question, lastRound1Answers);
    chatExchanges[chatExchanges.length - 1].roundRobin = roundRobinAnswers;
    renderHistory();
    showRoundRobinSpinner(false);
  });

  function showSubmitSpinner(on) {
    const submitSpinner = document.getElementById("submitSpinner");
    const submitBtn = document.getElementById("submitBtn");
    if (on) {
      submitSpinner.classList.remove("hidden");
      submitBtn.disabled = true;
    } else {
      submitSpinner.classList.add("hidden");
      submitBtn.disabled = false;
    }
  }
  function showRoundRobinSpinner(on) {
    const roundRobinSpinner = document.getElementById("roundRobinSpinner");
    const roundRobinBtn = document.getElementById("roundRobinBtn");
    if (on) {
      roundRobinSpinner.classList.remove("hidden");
      roundRobinBtn.disabled = true;
    } else {
      roundRobinSpinner.classList.add("hidden");
      roundRobinBtn.disabled = false;
    }
  }

  document.getElementById("chatInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      document.getElementById("chatForm").requestSubmit();
    }
  });

  renderHistory();

  // Help modal logic
  const helpBtn = document.getElementById('helpBtn');
  const helpModal = document.getElementById('helpModal');
  const helpModalClose = document.getElementById('helpModalClose');
  helpBtn.addEventListener('click', () => {
    helpModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  });
  helpModalClose.addEventListener('click', () => {
    helpModal.classList.add('hidden');
    document.body.style.overflow = '';
  });
  helpModal.addEventListener('click', e => {
    if(e.target === helpModal){
      helpModal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  });
</script>
</body>
</html>
