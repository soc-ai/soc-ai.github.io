<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Auto Parts Customer Summary</title>
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #020617;
      --border-subtle: #1e293b;
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --text: #e5e7eb;
      --text-soft: #94a3b8;
      --text-strong: #f9fafb;
      --table-header-bg: #020617;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
      --radius-lg: 18px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --transition-fast: 180ms ease-out;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1f2937, #020617 55%);
      color: var(--text);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(to bottom right, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.12);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-header {
      padding: 18px 22px 14px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.14), transparent 55%);
    }

    .app-title-block { display: flex; flex-direction: column; gap: 2px; }

    .app-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text-strong);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title-pill {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      background: rgba(56, 189, 248, 0.12);
      color: var(--accent-strong);
      border: 1px solid rgba(56, 189, 248, 0.45);
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .app-subtitle { font-size: 12px; color: var(--text-soft); }

    .header-actions { display: flex; gap: 10px; align-items: center; }

    .badge-soft {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
    }

    .badge-soft span { font-weight: 500; color: var(--text); }

    .pill-small {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.9);
      border: 1px dashed rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
    }

    .app-body {
      display: flex;
      gap: 18px;
      padding: 18px 18px 20px;
      flex-wrap: wrap;
    }

    .panel-main {
      flex: 1 1 60%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .panel-side {
      flex: 1 1 35%;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), var(--bg-card));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 16px;
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .card-subtitle { font-size: 11px; color: var(--text-soft); }

    .card-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.45);
      color: var(--text-soft);
    }

    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

    .status-text { font-size: 11px; color: var(--text-soft); margin-top: 6px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.85), #020617);
    }

    thead { background: var(--table-header-bg); }

    th, td {
      padding: 7px 8px;
      font-size: 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.95);
    }

    th {
      text-align: left;
      color: var(--text-soft);
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.14), #020617);
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    th:hover {
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.18), #020617);
    }

    th.sorted-asc, th.sorted-desc { color: var(--accent-strong); }
    th.sorted-asc::after, th.sorted-desc::after {
      position: absolute;
      right: 8px;
      font-size: 10px;
    }
    th.sorted-asc::after { content: "▲"; }
    th.sorted-desc::after { content: "▼"; }

    tbody tr:nth-child(even),
    tbody tr:nth-child(odd) { background: #020617; }

    tbody tr:hover {
      background: radial-gradient(circle at left, rgba(56, 189, 248, 0.12), #020617);
    }

    td { color: var(--text); }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      border-radius: var(--radius-pill);
      font-size: 12px;
      font-weight: 500;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast),
                  transform 120ms ease-out, box-shadow var(--transition-fast);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
    }

    .btn-primary {
      background: linear-gradient(to right, #0ea5e9, #22c55e);
      border-color: rgba(56, 189, 248, 0.9);
      color: #0f172a;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5), 0 15px 35px rgba(8, 47, 73, 0.9);
    }

    .btn-primary:hover {
      background: linear-gradient(to right, #06b6d4, #16a34a);
      transform: translateY(-1px);
      box-shadow: 0 18px 35px rgba(8, 47, 73, 1);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--text-soft);
    }

    .btn-secondary:hover {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
      transform: translateY(-1px);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(15, 23, 42, 0.2);
      border-top-color: #0f172a;
      border-right-color: #0f172a;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.1);
      animation: spin 600ms linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .spinner-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 150ms ease-out;
    }

    .spinner-overlay.visible { opacity: 1; pointer-events: auto; }

    .spinner-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.9);
      font-size: 11px;
      color: var(--text-soft);
    }

    .spinner-panel-label {
      font-size: 11px;
      color: var(--accent-strong);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      font-weight: 500;
    }

    #analysis {
      white-space: pre-wrap;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      padding: 10px 12px;
      margin-top: 8px;
      font-size: 12px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.92), #020617);
      color: var(--text);
      max-height: 260px;
      overflow-y: auto;
    }

    #analysis.empty { color: var(--text-soft); font-style: italic; }

    .analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .analysis-header-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .analysis-header-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: rgba(8, 47, 73, 0.8);
      color: var(--accent);
      border: 1px solid rgba(56, 189, 248, 0.7);
    }

    .analysis-label { font-size: 11px; color: var(--text-soft); margin-top: 2px; }

    @media (max-width: 900px) { .app-body { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-block">
        <div class="app-title">
          Auto Parts Customers
          <span class="app-title-pill">CSV Explorer</span>
        </div>
        <div class="app-subtitle">
          Autoloads <code>autoparts.csv</code> from this GitHub repo and analyzes customers with Together.ai.
        </div>
      </div>
      <div class="header-actions">
        <div class="badge-soft">
          <span class="badge-dot"></span>
          <span>DeepSeek-V3.1</span>
        </div>
        <div class="pill-small">Together.ai · Analysis</div>
      </div>
    </header>

    <main class="app-body">
      <!-- Left: summary table -->
      <section class="panel-main">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Customer CSV</div>
              <div class="card-subtitle">Customer_ID · Total_Spend · Total_Purchases · Total_Returns</div>
            </div>
            <span class="card-tag">Summary · 4 columns</span>
          </div>

          <!-- No file picker anymore -->
          <div id="status" class="status-text">
            Loading autoparts.csv from GitHub…
          </div>

          <table id="customerTable">
            <thead>
              <tr>
                <th data-key="Customer_ID">Customer ID</th>
                <th data-key="Total_Spend">Total Spend</th>
                <th data-key="Total_Purchases">Total Purchases</th>
                <th data-key="Total_Returns">Total Returns</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="spinner-overlay visible" id="tableSpinner">
            <div class="spinner-panel">
              <div class="spinner-panel-label">Loading</div>
              <div class="spinner"></div>
              <div>Preparing table…</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Together.ai -->
      <section class="panel-side">
        <div class="card" style="min-height: 220px;">
          <div class="card-header">
            <div>
              <div class="card-title">Together.ai Insight</div>
              <div class="card-subtitle">Send a subset of customers to DeepSeek for quick analysis.</div>
            </div>
            <span class="card-tag">Top 20 sample</span>
          </div>

          <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
            <button class="btn btn-primary" id="analyzeBtn">⚡ Analyze with Together.ai</button>
            <button class="btn btn-secondary" id="clearBtn">Clear Output</button>
          </div>

          <div class="analysis-header">
            <div>
              <div class="analysis-header-title">Model response</div>
              <div class="analysis-label">High-level summary of value and return behavior.</div>
            </div>
            <div class="analysis-header-pill">Auto parts · Summary</div>
          </div>

          <div id="analysis" class="empty">
            No analysis yet. Data will be ready after autoparts.csv loads.
          </div>

          <div class="spinner-overlay" id="analysisSpinner">
            <div class="spinner-panel">
              <div class="spinner-panel-label">Analyzing</div>
              <div class="spinner"></div>
              <div>DeepSeek is analyzing your customers…</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // === CONFIG: set this to your actual raw GitHub URL ===
    // Example:
    // const CSV_URL = 'http://soc-ai.github.io/autoparts.csv';
    const CSV_URL = 'https://soc-ai.github.io/autoparts.csv';

    const TOGETHER_API_KEY = 'YOUR_TOGETHER_API_KEY_HERE';
    const TOGETHER_API_URL = 'https://api.together.ai/v1/chat/completions';
    const TOGETHER_MODEL = 'deepseek-ai/DeepSeek-V3.1';

    const statusDiv = document.getElementById('status');
    const table = document.getElementById('customerTable');
    const tbody = table.querySelector('tbody');
    const tableSpinner = document.getElementById('tableSpinner');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const analysisDiv = document.getElementById('analysis');
    const analysisSpinner = document.getElementById('analysisSpinner');

    let tableData = [];
    let currentSort = { key: null, direction: 'asc' };

    function setTableSpinner(visible) {
      tableSpinner.classList.toggle('visible', visible);
    }

    function setAnalysisSpinner(visible) {
      analysisSpinner.classList.toggle('visible', visible);
    }

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(',');
      const rows = lines.slice(1).map(function (line) {
        const cols = line.split(',');
        const row = {};
        headers.forEach(function (h, i) {
          row[h.trim()] = cols[i] !== undefined ? cols[i].trim() : '';
        });
        return row;
      });
      return { headers, rows };
    }

    function renderTable() {
      tbody.innerHTML = '';
      tableData.forEach(function (row) {
        const cId = row.Customer_ID;
        const spend = Number(row.Total_Spend || 0);
        const purchases = Number(row.Total_Purchases || 0);
        const returns = Number(row.Total_Returns || 0);
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + cId + '</td>' +
          '<td>' + spend.toFixed(2) + '</td>' +
          '<td>' + purchases + '</td>' +
          '<td>' + returns + '</td>';
        tbody.appendChild(tr);
      });
    }

    function sortBy(key) {
      const numeric = key !== 'Customer_ID';
      if (currentSort.key === key) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.key = key;
        currentSort.direction = 'asc';
      }

      tableData.sort(function (a, b) {
        let va = a[key];
        let vb = b[key];
        if (numeric) {
          va = Number(va || 0);
          vb = Number(vb || 0);
        }
        if (va < vb) return currentSort.direction === 'asc' ? -1 : 1;
        if (va > vb) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      table.querySelectorAll('th').forEach(function (th) {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.key === key) {
          th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });

      renderTable();
    }

    table.querySelectorAll('th').forEach(function (th) {
      th.addEventListener('click', function () {
        const key = th.dataset.key;
        if (key) sortBy(key);
      });
    });

    async function loadCSVFromGitHub() {
      setTableSpinner(true);
      statusDiv.textContent = 'Loading autoparts.csv from GitHub…';

      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const parsed = parseCSV(text);

        tableData = parsed.rows.map(function (r) {
          return {
            Customer_ID: r['Customer_ID'],
            Total_Spend: r['Total_Spend'],
            Total_Purchases: r['Total_Purchases'],
            Total_Returns: r['Total_Returns']
          };
        });

        statusDiv.textContent =
          'Loaded ' + parsed.rows.length + ' rows from autoparts.csv (GitHub).';
        currentSort = { key: null, direction: 'asc' };
        table.querySelectorAll('th').forEach(function (th) {
          th.classList.remove('sorted-asc', 'sorted-desc');
        });
        renderTable();
      } catch (err) {
        statusDiv.textContent =
          'Could not load autoparts.csv from GitHub. Check CSV_URL and that the file is public.';
        console.error(err);
      } finally {
        setTableSpinner(false);
      }
    }

    analyzeBtn.addEventListener('click', async function () {
      if (!tableData.length) {
        analysisDiv.classList.add('empty');
        analysisDiv.textContent = 'No data loaded yet. Wait for autoparts.csv to load.';
        return;
      }

      analyzeBtn.disabled = true;
      setAnalysisSpinner(true);
      analysisDiv.classList.remove('empty');
      analysisDiv.textContent = 'Analyzing with Together.ai…';

      const sampleRows = tableData.slice(0, 20);
      const summaryLines = sampleRows.map(function (r) {
        return r.Customer_ID + ': spend=' + r.Total_Spend +
               ', purchases=' + r.Total_Purchases +
               ', returns=' + r.Total_Returns;
      }).join('\n');

      const userPrompt =
        'You are analyzing auto parts customer summary data.\n' +
        'Each line is: Customer_ID: spend, purchases, returns.\n\n' +
        'Data:\n' + summaryLines + '\n\n' +
        'Give a concise insight: which customers look highest value, and what patterns in returns do you see?';

      try {
        const response = await fetch(TOGETHER_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + TOGETHER_API_KEY
          },
          body: JSON.stringify({
            model: TOGETHER_MODEL,
            messages: [
              { role: 'system', content: 'You are a helpful data analyst for an auto parts retailer.' },
              { role: 'user', content: userPrompt }
            ],
            max_tokens: 512,
            temperature: 0.2
          })
        });

        if (!response.ok) {
          const txt = await response.text();
          throw new Error('HTTP ' + response.status + ': ' + txt);
        }

        const data = await response.json();
        const content =
          data.choices &&
          data.choices[0] &&
          data.choices[0].message &&
          data.choices[0].message.content
            ? data.choices[0].message.content
            : '(no content)';
        analysisDiv.textContent = content;
      } catch (err) {
        analysisDiv.textContent = 'Error calling Together.ai: ' + err.message;
      } finally {
        analyzeBtn.disabled = false;
        setAnalysisSpinner(false);
      }
    });

    clearBtn.addEventListener('click', function () {
      analysisDiv.classList.add('empty');
      analysisDiv.textContent =
        'No analysis yet. Once autoparts.csv loads, click “Analyze with Together.ai”.';
    });

    document.addEventListener('DOMContentLoaded', loadCSVFromGitHub);
  </script>
</body>
</html>
