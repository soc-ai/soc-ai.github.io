<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chat SPA - Gemini & Mistral</title>
  <!-- Google Fonts for modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: #f7f7f8;
      color: #23272f;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #app {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 260px;
      background: #fff;
      border-right: 1px solid #e3e6ea;
      display: flex;
      flex-direction: column;
      padding: 0 0 12px 0;
      position: relative;
      min-width: 200px;
    }
    .sidebar-header {
      padding: 20px 24px 12px 24px;
      border-bottom: 1px solid #e3e6ea;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .picker {
      font-size: 1rem;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #e3e6ea;
      background: #f7f7f8;
      margin-right: 8px;
    }
    .api-key-input {
      flex: 1;
      font-size: 0.95rem;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #e3e6ea;
      background: #f7f7f8;
      margin-right: 4px;
    }
    .save-key-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: none;
      background: #4f8cff;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .conversations {
      flex: 1;
      overflow-y: auto;
      padding: 12px 0;
    }
    .conversation {
      padding: 10px 24px;
      cursor: pointer;
      border-left: 4px solid transparent;
      transition: background 0.15s, border-color 0.15s;
      color: #23272f;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation.active {
      background: #eaf1ff;
      border-left: 4px solid #4f8cff;
      font-weight: 600;
    }
    .new-convo-btn {
      position: absolute;
      left: 16px;
      bottom: 16px;
      right: 16px;
      width: calc(100% - 32px);
      padding: 10px 0;
      background: #4f8cff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(79,140,255,0.08);
      transition: background 0.15s;
    }
    .new-convo-btn:hover {
      background: #376fc9;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f7f7f8;
      height: 100vh;
      min-width: 0;
    }
    .chat-header {
      padding: 18px 32px 12px 32px;
      font-size: 1.2rem;
      font-weight: 600;
      color: #4f8cff;
      border-bottom: 1px solid #e3e6ea;
      background: #fff;
    }
    .chat-messages {
      flex: 1;
      padding: 24px 32px 16px 32px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .msg {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      max-width: 700px;
    }
    .msg.user .bubble {
      background: #4f8cff;
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .msg.assistant .bubble {
      background: #fff;
      color: #23272f;
      border: 1px solid #e3e6ea;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    .bubble {
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 1.05rem;
      line-height: 1.5;
      box-shadow: 0 1px 4px rgba(0,0,0,0.03);
      max-width: 90vw;
      word-break: break-word;
    }
    .msg .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e3e6ea;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #4f8cff;
      flex-shrink: 0;
    }
    .msg.user .avatar {
      background: #4f8cff;
      color: #fff;
    }
    .chat-input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 16px 32px;
      background: #fff;
      border-top: 1px solid #e3e6ea;
    }
    .chat-input {
      flex: 1;
      font-size: 1.07rem;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid #e3e6ea;
      background: #f7f7f8;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      outline: none;
      transition: border 0.15s;
    }
    .send-btn {
      background: #4f8cff;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .send-btn:disabled {
      background: #b5d0ff;
      cursor: not-allowed;
    }
    @media (max-width: 700px) {
      .sidebar { width: 56px; min-width: 56px; }
      .sidebar-header, .conversation { padding-left: 10px; padding-right: 10px; }
      .main { padding: 0; }
      .chat-header, .chat-messages, .chat-input-row { padding-left: 10px; padding-right: 10px; }
      .new-convo-btn { left: 6px; right: 6px; width: calc(100% - 12px);}
    }
  </style>
</head>
<body>
<div id="app"></div>
<script>
/* --- Service Definitions --- */
const SERVICES = [
  {
    id: 'gemini',
    name: 'Gemini',
    icon: '<i class="fa-solid fa-gem"></i>',
    apiKeyName: 'gemini_api_key',
    sendMessage: async ({apiKey, messages}) => {
      // Gemini API: https://ai.google.dev/tutorials/rest_quickstart
      const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + encodeURIComponent(apiKey);
      const body = {
        contents: messages.map(m => ({
          role: m.role === 'user' ? 'user' : 'model',
          parts: [{text: m.content}]
        }))
      };
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
        return data.candidates[0].content.parts[0].text;
      }
      throw new Error(data.error?.message || "No response from Gemini");
    }
  },
  {
    id: 'mistral',
    name: 'Mistral',
    icon: '<i class="fa-solid fa-wind"></i>',
    apiKeyName: 'mistral_api_key',
    sendMessage: async ({apiKey, messages}) => {
      // Mistral API: https://docs.mistral.ai/api/
      const url = "https://api.mistral.ai/v1/chat/completions";
      const body = {
        model: "mistral-large-latest",
        messages: messages.map(m => ({
          role: m.role,
          content: m.content
        }))
      };
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + apiKey
        },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data && data.choices && data.choices[0] && data.choices[0].message) {
        return data.choices[0].message.content;
      }
      throw new Error(data.error?.message || "No response from Mistral");
    }
  }
];

/* --- Local Storage Helpers --- */
function saveApiKey(serviceId, key) {
  localStorage.setItem(`${serviceId}_api_key`, key);
}
function getApiKey(serviceId) {
  return localStorage.getItem(`${serviceId}_api_key`) || '';
}
function saveConversations(serviceId, conversations) {
  localStorage.setItem(`${serviceId}_conversations`, JSON.stringify(conversations));
}
function loadConversations(serviceId) {
  const raw = localStorage.getItem(`${serviceId}_conversations`);
  return raw ? JSON.parse(raw) : [];
}

/* --- State --- */
let state = {
  serviceId: SERVICES[0].id,
  apiKeys: {},
  conversations: {},
  currentConversationId: null
};

/* --- Initialization --- */
function initState() {
  state.apiKeys = {};
  state.conversations = {};
  for (const svc of SERVICES) {
    state.apiKeys[svc.id] = getApiKey(svc.id);
    state.conversations[svc.id] = loadConversations(svc.id);
    if (!state.conversations[svc.id].length) {
      // Create a default conversation
      const id = makeId();
      state.conversations[svc.id] = [{
        id,
        name: "New Chat",
        messages: []
      }];
      saveConversations(svc.id, state.conversations[svc.id]);
    }
  }
  state.currentConversationId = state.conversations[state.serviceId][0].id;
}
function makeId() {
  return Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
}

/* --- UI Rendering --- */
function render() {
  const svc = SERVICES.find(s => s.id === state.serviceId);
  const conversations = state.conversations[state.serviceId];
  const currentConv = conversations.find(c => c.id === state.currentConversationId) || conversations[0];

  document.getElementById('app').innerHTML = `
    <div class="sidebar">
      <div class="sidebar-header">
        <select class="picker" id="service-picker">
          ${SERVICES.map(s => `<option value="${s.id}" ${s.id === state.serviceId ? 'selected' : ''}>${s.icon} ${s.name}</option>`).join('')}
        </select>
        <input class="api-key-input" id="api-key-input" type="password" placeholder="${svc.name} API Key" value="${state.apiKeys[svc.id] || ''}">
        <button class="save-key-btn" id="save-key-btn" title="Save API Key"><i class="fa-solid fa-floppy-disk"></i></button>
      </div>
      <div class="conversations" id="conversations-list">
        ${conversations.map(c => `
          <div class="conversation${c.id === state.currentConversationId ? ' active' : ''}" data-id="${c.id}" title="${c.name}">
            <i class="fa-regular fa-comments"></i> ${c.name}
          </div>
        `).join('')}
      </div>
      <button class="new-convo-btn" id="new-convo-btn"><i class="fa-solid fa-plus"></i> New conversation</button>
    </div>
    <div class="main">
      <div class="chat-header">${svc.icon} ${svc.name}</div>
      <div class="chat-messages" id="chat-messages">
        ${currentConv.messages.length === 0 ? `
          <div style="color:#b0b8c1; font-size:1.1rem; margin-top:40px;">Start the conversation…</div>
        ` : currentConv.messages.map(m => `
          <div class="msg ${m.role}">
            <div class="avatar">${m.role === 'user' ? '<i class="fa-solid fa-user"></i>' : '<i class="fa-solid fa-robot"></i>'}</div>
            <div class="bubble">${escapeHTML(m.content)}</div>
          </div>
        `).join('')}
      </div>
      <form class="chat-input-row" id="chat-form" autocomplete="off">
        <textarea class="chat-input" id="chat-input" placeholder="Type your message…" rows="1"></textarea>
        <button class="send-btn" id="send-btn" type="submit"><i class="fa-solid fa-paper-plane"></i></button>
      </form>
    </div>
  `;

  // Event bindings
  document.getElementById('service-picker').onchange = e => {
    state.serviceId = e.target.value;
    // Switch to first conversation of new service
    const newConvs = state.conversations[state.serviceId];
    state.currentConversationId = newConvs.length ? newConvs[0].id : null;
    render();
  };
  document.getElementById('api-key-input').oninput = e => {
    state.apiKeys[svc.id] = e.target.value;
  };
  document.getElementById('save-key-btn').onclick = () => {
    saveApiKey(svc.id, state.apiKeys[svc.id]);
    alert('API key saved for ' + svc.name);
  };
  document.getElementById('conversations-list').onclick = e => {
    const el = e.target.closest('.conversation');
    if (el) {
      state.currentConversationId = el.dataset.id;
      render();
    }
  };
  document.getElementById('new-convo-btn').onclick = () => {
    const newId = makeId();
    const conv = {id: newId, name: "New Chat", messages: []};
    state.conversations[svc.id].unshift(conv);
    state.currentConversationId = newId;
    saveConversations(svc.id, state.conversations[svc.id]);
    render();
  };
  document.getElementById('chat-form').onsubmit = async e => {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    await sendMessage(text);
  };
  // Enter to send, Shift+Enter for newline
  document.getElementById('chat-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      document.getElementById('send-btn').click();
    }
  });
  // Scroll to bottom
  setTimeout(() => {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 50);
}

/* --- Messaging Logic --- */
async function sendMessage(text) {
  const svc = SERVICES.find(s => s.id === state.serviceId);
  const apiKey = state.apiKeys[svc.id];
  if (!apiKey) {
    alert('Please enter and save your ' + svc.name + ' API key.');
    return;
  }
  const conversations = state.conversations[svc.id];
  const conv = conversations.find(c => c.id === state.currentConversationId);
  if (!conv) return;

  conv.messages.push({role: 'user', content: text});
  render();
  try {
    // Show "assistant is typing"
    conv.messages.push({role: 'assistant', content: '…'});
    render();
    const messagesForApi = conv.messages
      .filter(m => m.role === 'user' || m.role === 'assistant')
      .map(m => ({role: m.role, content: m.content}));
    // Remove the placeholder
    conv.messages.pop();
    const reply = await svc.sendMessage({apiKey, messages: messagesForApi});
    conv.messages.push({role: 'assistant', content: reply});
  } catch (err) {
    conv.messages.pop();
    conv.messages.push({role: 'assistant', content: '[Error: ' + (err.message || err) + ']'});
  }
  saveConversations(svc.id, conversations);
  render();
}

/* --- Utility --- */
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, function(m) {
    return ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m];
  });
}

/* --- Start --- */
initState();
render();
</script>
</body>
</html>
