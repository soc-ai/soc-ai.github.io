<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chat SPA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS for layout and responsiveness -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    html, body {
      height: 100%;
      background: #f7f7f8;
    }
    body {
      min-height: 100vh;
      margin: 0;
    }
    #app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      background: #fff;
    }
    #header {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #eee;
      background: #f0f0f0;
      gap: 1rem;
    }
    #service-picker {
      min-width: 130px;
    }
    #chat-history {
      flex: 1;
      padding: 1.5rem 1rem 1rem 1rem;
      overflow-y: auto;
      background: #fafbfc;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }
    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 0.7rem;
      padding: 0.6rem 0.9rem;
      border-radius: 1rem;
      max-width: 85%;
      word-break: break-word;
    }
    .chat-message.user {
      align-self: flex-end;
      background: #e6f0ff;
      color: #222;
    }
    .chat-message.assistant {
      align-self: flex-start;
      background: #f1f3f4;
      color: #222;
    }
    #footer {
      border-top: 1px solid #eee;
      padding: 0.7rem 1rem 0.7rem 1rem;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    #new-convo-btn {
      align-self: flex-start;
      margin-bottom: 0.3rem;
    }
    #chat-input-row {
      display: flex;
      gap: 0.7rem;
      align-items: center;
    }
    #chat-input {
      flex: 1;
      border-radius: 1.2rem;
      border: 1px solid #ccc;
      padding: 0.7rem 1rem;
      outline: none;
      font-size: 1rem;
      background: #fff;
      resize: none;
      min-height: 38px;
      max-height: 120px;
    }
    #send-btn {
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1976d2;
      color: #fff;
      border: none;
      font-size: 1.3rem;
      transition: background 0.2s;
    }
    #send-btn:disabled {
      background: #b3c6e0;
      color: #fff;
    }
    #api-key-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    #api-key-input {
      width: 180px;
      border-radius: 0.4rem;
      border: 1px solid #ccc;
      padding: 0.3rem 0.7rem;
      font-size: 1rem;
    }
    #save-key-btn {
      border-radius: 0.4rem;
      border: none;
      background: #1976d2;
      color: #fff;
      padding: 0.3rem 0.8rem;
      font-size: 1rem;
    }
    @media (max-width: 600px) {
      #app-container {
        max-width: 100vw;
        height: 100vh;
      }
      #chat-history {
        padding: 1rem 0.3rem 0.5rem 0.3rem;
      }
      #footer {
        padding: 0.5rem 0.3rem 0.5rem 0.3rem;
      }
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="header">
      <select id="service-picker" class="form-select form-select-sm"></select>
      <div id="api-key-row">
        <input type="password" id="api-key-input" class="form-control form-control-sm" placeholder="Social AI API key">
        <button id="save-key-btn" class="btn btn-sm btn-primary">Save</button>
      </div>
    </div>
    <div id="chat-history"></div>
    <div id="footer">
      <button id="new-convo-btn" class="btn btn-outline-secondary btn-sm"><i class="fa fa-plus"></i> New conversation</button>
      <div id="chat-input-row">
        <textarea id="chat-input" rows="1" placeholder="Type your message..."></textarea>
        <button id="send-btn" disabled><i class="fa fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script>
    // --- Service Definitions ---
    const SERVICES = [
      {
        id: 'together',
        name: 'Social AI',
        apiKeyName: 'together_api_key',
        supports: ['chat'],
        // Default model for demo; can be made user-selectable
        chatModel: 'mistralai/Mixtral-8x7B-Instruct-v0.1',
        sendChat: async ({messages, apiKey, model}) => {
          // Together.ai chat completions endpoint
          const url = 'https://api.together.xyz/v1/chat/completions';
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
            },
            body: JSON.stringify({
              model,
              messages,
              max_tokens: 1024,
              temperature: 0.7
            })
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error?.message || res.statusText || 'API error');
          }
          const data = await res.json();
          // Return the assistant's reply
          return data.choices?.[0]?.message?.content || '[No response]';
        }
      },
      // Add more services here as needed, e.g. Gemini, OpenAI, etc.
    ];

    // --- State ---
    let currentServiceId = localStorage.getItem('selected_service') || SERVICES[0].id;
    let apiKeys = {};
    let conversations = {}; // {serviceId: [ {id, messages: [{role, content}], createdAt} ]}
    let currentConversationId = null;

    // --- DOM Elements ---
    const servicePicker = document.getElementById('service-picker');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveKeyBtn = document.getElementById('save-key-btn');
    const chatHistory = document.getElementById('chat-history');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const newConvoBtn = document.getElementById('new-convo-btn');

    // --- Utility Functions ---
    function getServiceById(id) {
      return SERVICES.find(s => s.id === id);
    }
    function getApiKey(serviceId) {
      return localStorage.getItem(getServiceById(serviceId).apiKeyName) || '';
    }
    function setApiKey(serviceId, key) {
      localStorage.setItem(getServiceById(serviceId).apiKeyName, key);
    }
    function saveConversations() {
      localStorage.setItem('chat_conversations', JSON.stringify(conversations));
    }
    function loadConversations() {
      conversations = JSON.parse(localStorage.getItem('chat_conversations') || '{}');
    }
    function getCurrentConversations() {
      return conversations[currentServiceId] || [];
    }
    function saveCurrentConversations(list) {
      conversations[currentServiceId] = list;
      saveConversations();
    }
    function uuid() {
      return 'xxxxxxxxyxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r&0x3|0x8)).toString(16);
      });
    }
    function formatDate(ts) {
      const d = new Date(ts);
      return d.toLocaleString();
    }

    // --- UI Rendering ---
    function renderServicePicker() {
      servicePicker.innerHTML = '';
      SERVICES.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        servicePicker.appendChild(opt);
      });
      servicePicker.value = currentServiceId;
    }
    function renderApiKeyInput() {
      apiKeyInput.value = getApiKey(currentServiceId);
    }
    function renderChatHistory() {
      chatHistory.innerHTML = '';
      const conv = getCurrentConversation();
      if (!conv) {
        chatHistory.innerHTML = '<div class="text-secondary text-center mt-5">Start a new conversation!</div>';
        return;
      }
      conv.messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-message ' + (msg.role === 'user' ? 'user' : 'assistant');
        div.innerHTML = `<span>${msg.role === 'user' ? '<i class="fa fa-user"></i>' : '<i class="fa fa-robot"></i>'}</span>
          <span>${escapeHtml(msg.content)}</span>`;
        chatHistory.appendChild(div);
      });
      // Scroll to bottom
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    function render() {
      renderServicePicker();
      renderApiKeyInput();
      renderChatHistory();
      sendBtn.disabled = !chatInput.value.trim() || !getApiKey(currentServiceId) || !getCurrentConversation();
    }
    function escapeHtml(str) {
      return (str||'').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[c]);
    }

    // --- Conversation Management ---
    function createNewConversation() {
      const convs = getCurrentConversations();
      const newConv = {
        id: uuid(),
        messages: [],
        createdAt: Date.now()
      };
      convs.push(newConv);
      saveCurrentConversations(convs);
      currentConversationId = newConv.id;
      localStorage.setItem('current_conversation_' + currentServiceId, currentConversationId);
      render();
    }
    function getCurrentConversation() {
      const convs = getCurrentConversations();
      if (!currentConversationId) {
        currentConversationId = localStorage.getItem('current_conversation_' + currentServiceId);
      }
      let conv = convs.find(c => c.id === currentConversationId);
      if (!conv && convs.length) {
        conv = convs[convs.length-1];
        currentConversationId = conv.id;
        localStorage.setItem('current_conversation_' + currentServiceId, currentConversationId);
      }
      return conv;
    }
    function addMessageToCurrentConversation(role, content) {
      const conv = getCurrentConversation();
      if (!conv) return;
      conv.messages.push({role, content});
      saveCurrentConversations(getCurrentConversations());
    }

    // --- Event Handlers ---
    servicePicker.addEventListener('change', () => {
      currentServiceId = servicePicker.value;
      localStorage.setItem('selected_service', currentServiceId);
      renderApiKeyInput();
      // Load conversation for this service
      currentConversationId = null;
      render();
    });
    saveKeyBtn.addEventListener('click', () => {
      setApiKey(currentServiceId, apiKeyInput.value.trim());
      render();
    });
    apiKeyInput.addEventListener('input', () => {
      saveKeyBtn.disabled = !apiKeyInput.value.trim();
    });
    chatInput.addEventListener('input', () => {
      sendBtn.disabled = !chatInput.value.trim() || !getApiKey(currentServiceId) || !getCurrentConversation();
      // Auto-grow textarea
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    });
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });
    sendBtn.addEventListener('click', async () => {
      const msg = chatInput.value.trim();
      if (!msg) return;
      chatInput.value = '';
      sendBtn.disabled = true;
      addMessageToCurrentConversation('user', msg);
      renderChatHistory();
      // Send to API
      const service = getServiceById(currentServiceId);
      const conv = getCurrentConversation();
      try {
        const reply = await service.sendChat({
          messages: conv.messages.map(m => ({role: m.role, content: m.content})),
          apiKey: getApiKey(currentServiceId),
          model: service.chatModel
        });
        addMessageToCurrentConversation('assistant', reply);
      } catch (err) {
        addMessageToCurrentConversation('assistant', '[Error: ' + (err.message || 'Failed to get response') + ']');
      }
      renderChatHistory();
      sendBtn.disabled = false;
      chatInput.focus();
    });
    newConvoBtn.addEventListener('click', () => {
      createNewConversation();
    });

    // --- Initialization ---
    function init() {
      loadConversations();
      renderServicePicker();
      renderApiKeyInput();
      // Load or create conversation for current service
      const convs = getCurrentConversations();
      currentConversationId = localStorage.getItem('current_conversation_' + currentServiceId);
      if (!convs.length) {
        createNewConversation();
      } else if (!getCurrentConversation()) {
        currentConversationId = convs[convs.length-1].id;
      }
      render();
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
