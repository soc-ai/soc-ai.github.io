<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chat SPA: Together AI & Gemini</title>
  <!-- Google Fonts for clean UI -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f7f7f8;
      color: #222;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .app-container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 280px;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 0 0 12px 0;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 18px 18px 12px 18px;
      border-bottom: 1px solid #e5e7eb;
      gap: 10px;
    }
    .service-picker {
      font-size: 1rem;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      outline: none;
    }
    .api-key-form {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      margin-bottom: 10px;
      padding: 0 18px;
    }
    .api-key-form input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 1rem;
    }
    .api-key-form button {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      background: #6366f1;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .api-key-form button:hover {
      background: #4f46e5;
    }
    .sidebar-convos {
      flex: 1;
      overflow-y: auto;
      margin: 0 0 8px 0;
      padding: 0 8px 0 8px;
    }
    .conversation-item {
      padding: 10px 14px;
      margin: 6px 0;
      border-radius: 7px;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .conversation-item.selected {
      background: #e0e7ff;
      font-weight: 600;
    }
    .conversation-item:not(.selected):hover {
      background: #f3f4f6;
    }
    .sidebar-footer {
      padding: 10px 18px 0 18px;
      border-top: 1px solid #e5e7eb;
    }
    .new-convo-btn {
      width: 100%;
      padding: 8px 0;
      border-radius: 6px;
      border: none;
      background: #22d3ee;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .new-convo-btn:hover {
      background: #06b6d4;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .chat-header {
      padding: 18px 26px 10px 26px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 28px 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .chat-message {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: 70%;
      padding: 0 26px;
    }
    .chat-message.user {
      align-self: flex-end;
      text-align: right;
    }
    .chat-message.assistant {
      align-self: flex-start;
      text-align: left;
    }
    .bubble {
      display: inline-block;
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 1.07rem;
      background: #f1f5f9;
      color: #222;
      margin-bottom: 2px;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .chat-message.user .bubble {
      background: #6366f1;
      color: #fff;
    }
    .chat-message.assistant .bubble {
      background: #e0e7ff;
      color: #222;
    }
    .chat-input-area {
      display: flex;
      align-items: flex-end;
      padding: 18px 26px 18px 26px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      gap: 10px;
    }
    .chat-input-area textarea {
      flex: 1;
      min-height: 38px;
      max-height: 120px;
      padding: 10px 12px;
      font-size: 1rem;
      border-radius: 7px;
      border: 1px solid #d1d5db;
      resize: vertical;
      outline: none;
      background: #f9fafb;
      transition: border 0.2s;
    }
    .chat-input-area button {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      background: #6366f1;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .chat-input-area button:disabled {
      background: #c7d2fe;
      cursor: not-allowed;
    }
    .chat-input-area button:not(:disabled):hover {
      background: #4f46e5;
    }
    @media (max-width: 900px) {
      .sidebar { width: 70px; }
      .sidebar-header, .sidebar-footer, .api-key-form { padding-left: 8px; padding-right: 8px; }
      .sidebar-header span, .conversation-item span { display: none; }
      .sidebar-convos { padding: 0 2px; }
    }
  </style>
</head>
<body>
<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <select class="service-picker" id="servicePicker">
        <option value="together">Together AI</option>
        <option value="gemini">Gemini</option>
      </select>
      <span id="serviceLabel">Together AI</span>
    </div>
    <form class="api-key-form" id="apiKeyForm" autocomplete="off">
      <input type="password" id="apiKeyInput" placeholder="Enter API key" required>
      <button type="submit">Save</button>
    </form>
    <div class="sidebar-convos" id="convoList"></div>
    <div class="sidebar-footer">
      <button class="new-convo-btn" id="newConvoBtn"><i class="fa fa-plus"></i> New conversation</button>
    </div>
  </div>
  <div class="main">
    <div class="chat-header" id="chatHeader">
      <i class="fa fa-robot"></i>
      <span id="chatTitle">New conversation</span>
    </div>
    <div class="chat-history" id="chatHistory"></div>
    <form class="chat-input-area" id="chatInputForm" autocomplete="off">
      <textarea id="chatInput" rows="1" placeholder="Type your message..." required></textarea>
      <button type="submit" id="sendBtn"><i class="fa fa-paper-plane"></i></button>
    </form>
  </div>
</div>
<script>
const SERVICES = {
  together: {
    label: "Together AI",
    model: "meta-llama/Llama-4-Scout-17B-16E-Instruct",
    apiKeyLabel: "Together AI",
  },
  gemini: {
    label: "Gemini",
    model: "gemini-2.0-flash",
    apiKeyLabel: "Gemini",
  }
};

const LS_KEYS = {
  apiKey: (service) => `apiKey_${service}`,
  conversations: (service) => `conversations_${service}`,
  selectedConvo: (service) => `selectedConvo_${service}`,
};

let state = {
  service: localStorage.getItem("lastService") || "together",
  apiKeys: {
    together: localStorage.getItem(LS_KEYS.apiKey("together")) || "",
    gemini: localStorage.getItem(LS_KEYS.apiKey("gemini")) || "",
  },
  conversations: {
    together: [],
    gemini: [],
  },
  selectedConvoId: {
    together: null,
    gemini: null,
  },
  loading: false,
};

// --- DOM Elements ---
const servicePicker = document.getElementById("servicePicker");
const serviceLabel = document.getElementById("serviceLabel");
const apiKeyForm = document.getElementById("apiKeyForm");
const apiKeyInput = document.getElementById("apiKeyInput");
const convoList = document.getElementById("convoList");
const newConvoBtn = document.getElementById("newConvoBtn");
const chatHeader = document.getElementById("chatHeader");
const chatTitle = document.getElementById("chatTitle");
const chatHistory = document.getElementById("chatHistory");
const chatInputForm = document.getElementById("chatInputForm");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

// --- Utility functions for localStorage ---
function saveApiKey(service, key) {
  localStorage.setItem(LS_KEYS.apiKey(service), key);
  state.apiKeys[service] = key;
}
function loadApiKey(service) {
  return localStorage.getItem(LS_KEYS.apiKey(service)) || "";
}
function saveConversations(service, conversations) {
  localStorage.setItem(LS_KEYS.conversations(service), JSON.stringify(conversations));
  state.conversations[service] = conversations;
}
function loadConversations(service) {
  const raw = localStorage.getItem(LS_KEYS.conversations(service));
  return raw ? JSON.parse(raw) : [];
}
function saveSelectedConvo(service, convoId) {
  localStorage.setItem(LS_KEYS.selectedConvo(service), convoId);
  state.selectedConvoId[service] = convoId;
}
function loadSelectedConvo(service) {
  return localStorage.getItem(LS_KEYS.selectedConvo(service));
}
function saveLastService(service) {
  localStorage.setItem("lastService", service);
}

function uuid() {
  // Simple UUID for conversations
  return "cxxxxxxx".replace(/[x]/g, () =>
    (Math.random() * 16 | 0).toString(16));
}

// --- Conversation Management ---
function createNewConversation(service) {
  const conversations = state.conversations[service];
  const newConvo = {
    id: uuid(),
    title: "New conversation",
    messages: [],
    createdAt: Date.now(),
  };
  conversations.unshift(newConvo);
  saveConversations(service, conversations);
  saveSelectedConvo(service, newConvo.id);
  renderConvoList();
  renderChat();
}

function selectConversation(service, convoId) {
  saveSelectedConvo(service, convoId);
  renderConvoList();
  renderChat();
}

function addMessageToConversation(service, convoId, role, content) {
  const conversations = state.conversations[service];
  const convo = conversations.find(c => c.id === convoId);
  if (!convo) return;
  convo.messages.push({ role, content, timestamp: Date.now() });
  if (role === "user" && convo.title === "New conversation") {
    // Use first user message as title (truncated)
    convo.title = content.length > 26 ? content.slice(0, 26) + "..." : content;
  }
  saveConversations(service, conversations);
  renderConvoList();
  renderChat();
}

// --- Render Functions ---
function renderServicePicker() {
  servicePicker.value = state.service;
  serviceLabel.textContent = SERVICES[state.service].label;
}

function renderApiKeyForm() {
  apiKeyInput.value = state.apiKeys[state.service];
  apiKeyInput.placeholder = `Enter ${SERVICES[state.service].apiKeyLabel} API key`;
}

function renderConvoList() {
  const conversations = state.conversations[state.service];
  const selectedId = state.selectedConvoId[state.service];
  convoList.innerHTML = "";
  if (conversations.length === 0) {
    convoList.innerHTML = `<div style="padding: 20px 10px; color: #888; font-size: 1rem;">No conversations yet</div>`;
    return;
  }
  conversations.forEach(convo => {
    const div = document.createElement("div");
    div.className = "conversation-item" + (convo.id === selectedId ? " selected" : "");
    div.innerHTML = `<i class="fa fa-comments"></i><span>${convo.title}</span>`;
    div.onclick = () => selectConversation(state.service, convo.id);
    convoList.appendChild(div);
  });
}

function renderChat() {
  const conversations = state.conversations[state.service];
  const selectedId = state.selectedConvoId[state.service];
  const convo = conversations.find(c => c.id === selectedId);
  chatHistory.innerHTML = "";
  if (!convo) {
    chatTitle.textContent = "New conversation";
    return;
  }
  chatTitle.textContent = convo.title;
  convo.messages.forEach(msg => {
    const msgDiv = document.createElement("div");
    msgDiv.className = "chat-message " + (msg.role === "user" ? "user" : "assistant");
    msgDiv.innerHTML = `<div class="bubble">${escapeHTML(msg.content)}</div>`;
    chatHistory.appendChild(msgDiv);
  });
  if (state.loading) {
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "chat-message assistant";
    loadingDiv.innerHTML = `<div class="bubble"><i class="fa fa-spinner fa-spin"></i> Thinking...</div>`;
    chatHistory.appendChild(loadingDiv);
  }
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, function(m) {
    return ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m];
  });
}

// --- Chat API Calls ---
async function sendMessageToAPI(service, apiKey, messages) {
  if (service === "together") {
    // Together AI API[3][6]
    const endpoint = "https://api.together.ai/v1/chat/completions";
    const payload = {
      model: SERVICES.together.model,
      messages: messages.map(m => ({
        role: m.role,
        content: [{ type: "text", text: m.content }]
      })),
    };
    const res = await fetch(endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`,
      },
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error(`Together API error: ${res.status}`);
    const data = await res.json();
    // The response is in data.choices[0].message.content[0].text
    const reply = data.choices?.[0]?.message?.content?.[0]?.text || "No response";
    return reply;
  } else if (service === "gemini") {
    // Gemini API[2]
    const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${SERVICES.gemini.model}:generateContent?key=${apiKey}`;
    const payload = {
      contents: [
        {
          parts: messages.map(m => ({ text: (m.role === "user" ? m.content : "") })).filter(p => p.text)
        }
      ]
    };
    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error(`Gemini API error: ${res.status}`);
    const data = await res.json();
    // The response is in data.candidates[0].content.parts[0].text
    const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
    return reply;
  }
  throw new Error("Unknown service");
}

// --- Event Listeners ---
servicePicker.addEventListener("change", () => {
  state.service = servicePicker.value;
  saveLastService(state.service);
  renderServicePicker();
  renderApiKeyForm();
  state.conversations[state.service] = loadConversations(state.service);
  state.selectedConvoId[state.service] = loadSelectedConvo(state.service) || (state.conversations[state.service][0]?.id || null);
  renderConvoList();
  renderChat();
});

apiKeyForm.addEventListener("submit", e => {
  e.preventDefault();
  const key = apiKeyInput.value.trim();
  if (!key) return;
  saveApiKey(state.service, key);
  renderApiKeyForm();
  alert("API key saved for " + SERVICES[state.service].label);
});

newConvoBtn.addEventListener("click", () => {
  createNewConversation(state.service);
});

chatInputForm.addEventListener("submit", async e => {
  e.preventDefault();
  if (state.loading) return;
  const text = chatInput.value.trim();
  if (!text) return;
  const service = state.service;
  const apiKey = state.apiKeys[service];
  if (!apiKey) {
    alert(`Please enter your ${SERVICES[service].label} API key first.`);
    return;
  }
  let conversations = state.conversations[service];
  let selectedId = state.selectedConvoId[service];
  if (!selectedId) {
    createNewConversation(service);
    conversations = state.conversations[service];
    selectedId = state.selectedConvoId[service];
  }
  addMessageToConversation(service, selectedId, "user", text);
  chatInput.value = "";
  state.loading = true;
  renderChat();
  try {
    const convo = conversations.find(c => c.id === selectedId);
    // Compose messages for API
    const apiMessages = convo.messages.map(m => ({
      role: m.role,
      content: m.content
    }));
    const reply = await sendMessageToAPI(service, apiKey, apiMessages);
    addMessageToConversation(service, selectedId, "assistant", reply);
  } catch (err) {
    addMessageToConversation(service, selectedId, "assistant", `[Error]: ${err.message}`);
  }
  state.loading = false;
  renderChat();
});

// --- Initialization ---
function init() {
  // Load all conversations and selected convo IDs
  for (const svc in SERVICES) {
    state.conversations[svc] = loadConversations(svc);
    state.selectedConvoId[svc] = loadSelectedConvo(svc) || (state.conversations[svc][0]?.id || null);
  }
  renderServicePicker();
  renderApiKeyForm();
  renderConvoList();
  renderChat();
}

init();
</script>
</body>
</html>
