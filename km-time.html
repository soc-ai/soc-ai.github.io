<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Time & Mileage Tracker</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; max-width: 900px; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: middle; }
  th { background-color: #f4f4f4; }
  input[type="time"], input[type="date"], input[type="number"], input[type="text"], textarea {
    width: 100%;
    box-sizing: border-box;
  }
  textarea { height: 70px; resize: vertical; }
  tfoot td { font-weight: bold; }
  .checkbox-center { text-align: center; }
  .tasks-col { width: 200px; } /* Tasks column wider */
  .total-time-col,
  .total-mileage-col {
    width: 90px;
  }
  label.weekOfLabel {
    font-weight: bold;
    margin-right: 8px;
  }
  #weekOfContainer {
    margin-bottom: 15px;
    max-width: 900px;  /* Match table width */
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #weekOfContainer > div {
    display: flex;
    align-items: center;
  }
  #authDownloadContainer {
    display: flex;
    align-items: center;
    gap: 10px;
    width: auto;
  }
  #codeInput {
    width: 70px;
    font-family: monospace;
    letter-spacing: 4px;
    padding: 8px 12px;
    font-size: 1rem;
  }
  #downloadBtn, #resetBtn {
    padding: 8px 16px;
    font-size: 1rem;
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>Weekly Time & Mileage Tracker</h2>

<div id="weekOfContainer">
  <div>
    <label for="weekOf" class="weekOfLabel">Week Of:</label>
    <input type="date" id="weekOf" />
  </div>
  <div id="authDownloadContainer">
    <button id="resetBtn" disabled>Reset Data</button>
    <input type="password" id="codeInput" maxlength="4" placeholder="Code" title="Enter 4-digit code to edit" />
    <button id="downloadBtn">Download Week Data</button>
  </div>
</div>

<table id="timeMileageTable">
  <thead>
    <tr>
      <th>Day</th>
      <th>Date</th>
      <th>Start Time</th>
      <th>End Time</th>
      <th class="total-time-col">Total Time (hrs)</th>
      <th>Start Mileage</th>
      <th>End Mileage</th>
      <th class="total-mileage-col">Total Mileage</th>
      <th class="tasks-col">Tasks</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows get inserted here by JS -->
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4" style="text-align:right;">Weekly Totals:</td>
      <td id="weeklyTotalTime" class="total-time-col">0.00</td>
      <td colspan="2" style="text-align:right;">Mileage Total:</td>
      <td id="weeklyTotalMileage" class="total-mileage-col">0</td>
      <td class="checkbox-center">
        <label>Paid <input type="checkbox" id="paidCheck" /></label>
      </td>
    </tr>
  </tfoot>
</table>

<script>
  const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  const tbody = document.querySelector("#timeMileageTable tbody");
  const weekOfInput = document.getElementById("weekOf");
  const downloadBtn = document.getElementById("downloadBtn");
  const resetBtn = document.getElementById("resetBtn");
  const codeInput = document.getElementById("codeInput");
  const paidCheckbox = document.getElementById("paidCheck");

  const SECRET_CODE = "1234"; // Customize your code here
  const STORAGE_KEY = "timeMileageAppData";

  // Create the rows for each day
  function createRows() {
    tbody.innerHTML = "";
    days.forEach(day => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${day}</td>
        <td><input type="date" /></td>
        <td><input type="time" /></td>
        <td><input type="time" /></td>
        <td class="total-time-col"><input type="number" readonly step="0.01" min="0" value="0" /></td>
        <td><input type="number" min="0" /></td>
        <td><input type="number" min="0" /></td>
        <td class="total-mileage-col"><input type="number" readonly min="0" value="0" /></td>
        <td><textarea placeholder="Describe tasks..." class="tasks-col"></textarea></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Save current data to localStorage
  function saveData() {
    const data = {
      weekOf: weekOfInput.value,
      paid: paidCheckbox.checked,
      rows: []
    };
    tbody.querySelectorAll("tr").forEach(row => {
      data.rows.push({
        date: row.cells[1].querySelector("input").value,
        startTime: row.cells[2].querySelector("input").value,
        endTime: row.cells[3].querySelector("input").value,
        totalTime: row.cells[4].querySelector("input").value,
        startMileage: row.cells[5].querySelector("input").value,
        endMileage: row.cells[6].querySelector("input").value,
        totalMileage: row.cells[7].querySelector("input").value,
        tasks: row.cells[8].querySelector("textarea").value
      });
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  // Load data from localStorage, if any
  function loadData() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return false;
    try {
      const data = JSON.parse(stored);
      if (data.weekOf) weekOfInput.value = data.weekOf;
      if (data.paid !== undefined) paidCheckbox.checked = data.paid;
      if (data.rows && data.rows.length === days.length) {
        tbody.querySelectorAll("tr").forEach((row, i) => {
          const rowData = data.rows[i];
          row.cells[1].querySelector("input").value = rowData.date || "";
          row.cells[2].querySelector("input").value = rowData.startTime || "";
          row.cells[3].querySelector("input").value = rowData.endTime || "";
          row.cells[4].querySelector("input").value = rowData.totalTime || "0";
          row.cells[5].querySelector("input").value = rowData.startMileage || "";
          row.cells[6].querySelector("input").value = rowData.endMileage || "";
          row.cells[7].querySelector("input").value = rowData.totalMileage || "0";
          row.cells[8].querySelector("textarea").value = rowData.tasks || "";
        });
        calculate();
        return true;
      }
    } catch {
      // ignore errors and treat as no data
    }
    return false;
  }

  // Set readOnly attribute or remove it based on code input; keep Paid checkbox always enabled
  function updateEditableState(canEdit) {
    tbody.querySelectorAll("tr").forEach(row => {
      for (let i=1; i <= 3; i++) { // Date, Start Time, End Time inputs
        const input = row.cells[i].querySelector("input");
        if (input) input.readOnly = !canEdit;
      }
      // Total Time and Mileage always readonly
      row.cells[4].querySelector("input").readOnly = true;
      row.cells[7].querySelector("input").readOnly = true;

      // Mileage inputs editable based on code
      for (let i=5; i <= 6; i++) {
        const input = row.cells[i].querySelector("input");
        if (input) input.readOnly = !canEdit;
      }
      // Tasks textarea editable based on code
      const textarea = row.cells[8].querySelector("textarea");
      if (textarea) textarea.readOnly = !canEdit;
    });

    // Week Of date input editable based on code
    weekOfInput.readOnly = !canEdit;

    // Reset button enabled only if editable
    resetBtn.disabled = !canEdit;
  }

  // Calculate totals for each row and weekly totals
  function calculate() {
    let totalTime = 0;
    let totalMileage = 0;

    tbody.querySelectorAll("tr").forEach(row => {
      const startTimeInput = row.cells[2].querySelector("input");
      const endTimeInput = row.cells[3].querySelector("input");
      const totalTimeInput = row.cells[4].querySelector("input");

      const startMileageInput = row.cells[5].querySelector("input");
      const endMileageInput = row.cells[6].querySelector("input");
      const totalMileageInput = row.cells[7].querySelector("input");

      let totalHrs = 0;
      if (startTimeInput.value && endTimeInput.value) {
        const start = new Date(`1970-01-01T${startTimeInput.value}:00`);
        let end = new Date(`1970-01-01T${endTimeInput.value}:00`);
        if (end < start) {
          end.setDate(end.getDate() + 1);
        }
        const diffMs = end - start;
        totalHrs = diffMs / (1000 * 60 * 60);
      }
      totalTimeInput.value = totalHrs.toFixed(2);
      totalTime += totalHrs;

      let mileage = 0;
      const startMile = parseFloat(startMileageInput.value);
      const endMile = parseFloat(endMileageInput.value);
      if (!isNaN(startMile) && !isNaN(endMile) && endMile >= startMile) {
        mileage = endMile - startMile;
      }
      totalMileageInput.value = mileage.toFixed(1);
      totalMileage += mileage;
    });

    document.getElementById("weeklyTotalTime").textContent = totalTime.toFixed(2);
    document.getElementById("weeklyTotalMileage").textContent = totalMileage.toFixed(1);

    // Save data whenever calculated (reflect latest)
    saveData();
  }

  // Initialize app
  function init() {
    createRows();
    if (!loadData()) {
      // No saved data, just calculate initially
      calculate();
    }
    updateEditableState(false);
  }
  
  init();

  // Event listeners for dynamic calculation
  tbody.addEventListener("input", e => {
    if (e.target.matches("input[type='time'], input[type='number'], input[type='date'], textarea")) {
      calculate();
    }
  });

  weekOfInput.addEventListener("input", saveData);
  paidCheckbox.addEventListener("change", saveData);

  codeInput.addEventListener("input", () => {
    const code = codeInput.value.trim();
    if (code === SECRET_CODE) {
      updateEditableState(true);
      codeInput.style.borderColor = "green";
    } else {
      updateEditableState(false);
      codeInput.style.borderColor = "";
    }
  });

  resetBtn.addEventListener("click", () => {
    if (codeInput.value.trim() !== SECRET_CODE) {
      alert("Enter the correct code to reset data.");
      return;
    }
    if (!confirm("Are you sure you want to reset all data? This cannot be undone.")) return;

    // Clear localStorage
    localStorage.removeItem(STORAGE_KEY);

    // Clear inputs
    init();

    // Clear code input and disable editing after reset
    codeInput.value = "";
    codeInput.style.borderColor = "";
    updateEditableState(false);
  });

  downloadBtn.addEventListener("click", () => {
    const weekOf = weekOfInput.value;
    if (!weekOf) {
      alert("Please select the 'Week Of' date before downloading.");
      return;
    }
    const dateHeader = `Week Of: ${weekOf}\n\n`;
    let content = dateHeader;
    content += "Day | Date | Start Time | End Time | Total Time (hrs) | Start Mileage | End Mileage | Total Mileage | Tasks\n";
    content += "-".repeat(110) + "\n";

    tbody.querySelectorAll("tr").forEach(row => {
      const day = row.cells[0].textContent;
      const date = row.cells[1].querySelector("input").value || "";
      const startTime = row.cells[2].querySelector("input").value || "";
      const endTime = row.cells[3].querySelector("input").value || "";
      const totalTime = row.cells[4].querySelector("input").value || "0.00";
      const startMileage = row.cells[5].querySelector("input").value || "";
      const endMileage = row.cells[6].querySelector("input").value || "";
      const totalMileage = row.cells[7].querySelector("input").value || "0.0";
      const tasks = row.cells[8].querySelector("textarea").value.trim().replace(/\r?\n/g, " ");

      content += `${day} | ${date} | ${startTime} | ${endTime} | ${totalTime} | ${startMileage} | ${endMileage} | ${totalMileage} | ${tasks}\n`;
    });

    const totalTimeWeek = document.getElementById("weeklyTotalTime").textContent;
    const totalMileageWeek = document.getElementById("weeklyTotalMileage").textContent;
    const paidChecked = document.getElementById("paidCheck").checked ? "Yes" : "No";

    content += "\n";
    content += `Weekly Total Time (hrs): ${totalTimeWeek}\n`;
    content += `Weekly Total Mileage: ${totalMileageWeek}\n`;
    content += `Paid: ${paidChecked}\n`;

    const filename = `WeekOf_${weekOf}.txt`;

    const blob = new Blob([content], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.style.display = "none";

    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
  });
</script>

</body>
</html>
